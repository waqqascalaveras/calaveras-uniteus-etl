<!--
================================================================================
Calaveras UniteUs ETL - Dashboard & Analytics Page
================================================================================
Developed by Waqqas Hanafi
Calaveras County Health and Human Services Agency

Description:
    Main dashboard page providing comprehensive analytics, visualizations,
    and reporting capabilities with 25+ charts and interactive filters.
================================================================================
-->
{% extends "base.html" %}

{% block title %}Dashboard - UniteUs ETL{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header with Global Filters -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>Dashboard & Analytics
        </h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#globalFiltersModal">
                <i class="fas fa-filter me-1"></i>Global Filters
            </button>
            <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#exportWordModal">
                <i class="fas fa-file-word me-1"></i>Export to Word
            </button>
        </div>
    </div>

    <!-- Quick Filters Ribbon -->
    <div class="mb-3">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <small class="text-muted fw-bold me-2">Quick Filters:</small>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="thisMonth" onclick="applyQuickFilter('thisMonth')">
                <i class="fas fa-calendar-day me-1"></i><span id="quickFilterThisMonth">This Month</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="lastMonth" onclick="applyQuickFilter('lastMonth')">
                <i class="fas fa-calendar-minus me-1"></i><span id="quickFilterLastMonth">Last Month</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="last30Days" onclick="applyQuickFilter('last30Days')">
                <i class="fas fa-calendar-alt me-1"></i>Last 30 Days
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="thisQuarter" onclick="applyQuickFilter('thisQuarter')">
                <i class="fas fa-calendar-week me-1"></i><span id="quickFilterThisQuarter">This Quarter</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="lastQuarter" onclick="applyQuickFilter('lastQuarter')">
                <i class="fas fa-calendar-week me-1"></i><span id="quickFilterLastQuarter">Last Quarter</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="thisYear" onclick="applyQuickFilter('thisYear')">
                <i class="fas fa-calendar me-1"></i><span id="quickFilterThisYear">This Year</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter-btn" data-filter="lastYear" onclick="applyQuickFilter('lastYear')">
                <i class="fas fa-calendar me-1"></i><span id="quickFilterLastYear">Last Year</span>
            </button>
        </div>
    </div>

    <!-- Global Filters Badge Display -->
    <div id="activeFiltersBadges" class="mb-3"></div>

    <!-- Navigation Tabs for Report Categories -->
    <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                <i class="fas fa-home me-1"></i>Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="demographics-tab" data-bs-toggle="tab" data-bs-target="#demographics" type="button">
                <i class="fas fa-users me-1"></i>Demographics
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button">
                <i class="fas fa-hands-helping me-1"></i>Services
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button">
                <i class="fas fa-network-wired me-1"></i>Network
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button">
                <i class="fas fa-tachometer-alt me-1"></i>Performance
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="outcomes-tab" data-bs-toggle="tab" data-bs-target="#outcomes" type="button">
                <i class="fas fa-check-circle me-1"></i>Outcomes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="geographic-tab" data-bs-toggle="tab" data-bs-target="#geographic" type="button">
                <i class="fas fa-map-marked-alt me-1"></i>Geographic
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button">
                <i class="fas fa-chart-line me-1"></i>Advanced
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="reportTabContent">
        
        <!-- ========== OVERVIEW TAB ========== -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center border-primary">
                        <div class="card-body">
                            <h3 class="text-primary mb-1" id="totalReferrals">-</h3>
                            <small class="text-muted">Total Referrals</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center border-success">
                        <div class="card-body">
                            <h3 class="text-success mb-1" id="totalCases">-</h3>
                            <small class="text-muted">Total Cases</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center border-info">
                        <div class="card-body">
                            <h3 class="text-info mb-1" id="totalPeople">-</h3>
                            <small class="text-muted">Unique People</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center border-warning">
                        <div class="card-body">
                            <h3 class="text-warning mb-1" id="totalAssistance">-</h3>
                            <small class="text-muted">Assistance Requests</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Overview Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-clipboard-list me-1"></i>Referrals by Status</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('referralStatusChart', 'referral-status')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="referralStatusChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-folder-open me-1"></i>Cases by Status</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('caseStatusChart', 'case-status')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="caseStatusChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-1"></i>Referrals Over Time</h6>
                            <div>
                                <select class="form-select form-select-sm d-inline-block w-auto me-2" id="timelineGrouping">
                                    <option value="day">Daily</option>
                                    <option value="week" selected>Weekly</option>
                                    <option value="month">Monthly</option>
                                </select>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChart('timelineChart', 'referrals-timeline')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="timelineChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Types -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-th-list me-1"></i>Cases by Service Type</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('serviceTypeChart', 'service-types')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="serviceTypeChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== DEMOGRAPHICS TAB ========== -->
        <div class="tab-pane fade" id="demographics" role="tabpanel">
            
            <div class="row mb-4">
                <!-- Age Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-birthday-cake me-1"></i>Age Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('ageDistChart', 'age-distribution')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="ageDistChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gender Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-venus-mars me-1"></i>Gender Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('genderChart', 'gender-distribution')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="genderChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Race/Ethnicity -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-globe me-1"></i>Race/Ethnicity</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('raceChart', 'race-ethnicity')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="raceChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Geographic Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-map-marker-alt me-1"></i>Cases by Location</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('geoTable', 'geographic-distribution')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-hover mb-0" id="geoTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>City</th>
                                            <th>County</th>
                                            <th>State</th>
                                            <th class="text-end">Cases</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Demographics Row -->
            <div class="row mb-4">
                <!-- Household Composition -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-users me-1"></i>Household Size Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('householdChart', 'household-composition')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="householdChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Household Adults vs Children Scatterplot -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-home me-1"></i>Adults vs Children per Household</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('householdScatterChart', 'household-adults-children')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="householdScatterChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income and Insurance Row -->
            <div class="row mb-4">
                <!-- Income Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-dollar-sign me-1"></i>Monthly Income Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('incomeChart', 'income-distribution')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="incomeChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Insurance Coverage -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-shield-alt me-1"></i>Insurance Coverage</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('insuranceChart', 'insurance-coverage')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="insuranceChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Preferences Row -->
            <div class="row mb-4">
                <!-- Communication Preferences -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-comment-dots me-1"></i>Communication Preferences</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('commPrefChart', 'communication-preferences')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>


                        <div class="card-body">
                            <canvas id="commPrefChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marital Status & Language Row -->
            <div class="row mb-4">
                <!-- Marital Status -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-ring me-1"></i>Marital Status Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('maritalChart', 'marital-status')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="maritalChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Language Preferences -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-language me-1"></i>Language Preferences</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('languageChart', 'language-preferences')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="languageChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Military Services -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-flag-usa me-1"></i>Military Affiliation</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('milAffChart', 'military-affiliation')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="milAffChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-medal me-1"></i>Military Branch</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('milBranchChart', 'military-branch')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="milBranchChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SERVICES TAB ========== -->
        <div class="tab-pane fade" id="services" role="tabpanel">
            
            <!-- Service Metrics -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-clock me-1"></i>Average Resolution Time by Service Type</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('resolutionTimeTable', 'resolution-time')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0" id="resolutionTimeTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Service Type</th>
                                            <th class="text-end">Total Cases</th>
                                            <th class="text-end">Avg Days</th>
                                            <th class="text-end">Min Days</th>
                                            <th class="text-end">Max Days</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Conversion -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-exchange-alt me-1"></i>Referral Acceptance Rates by Service Type</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('conversionTable', 'referral-conversion')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0" id="conversionTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Service Type</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-end">Accepted</th>
                                            <th class="text-end">Declined</th>
                                            <th class="text-end">Pending</th>
                                            <th class="text-end">Accept %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Subtypes -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-sitemap me-1"></i>Service Subtypes Detail</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('subtypesTable', 'service-subtypes')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-sm table-hover mb-0" id="subtypesTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Service Type</th>
                                            <th>Service Subtype</th>
                                            <th class="text-end">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outcomes -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-1"></i>Case Outcomes</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('outcomesTable', 'case-outcomes')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0" id="outcomesTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Resolution Type</th>
                                            <th class="text-end">Count</th>
                                            <th class="text-end">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== NETWORK TAB ========== -->
        <div class="tab-pane fade" id="network" role="tabpanel">
            
            <!-- Provider Activity -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-paper-plane me-1"></i>Top Sending Providers</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('sendingProvidersChart', 'sending-providers')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="sendingProvidersChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-inbox me-1"></i>Top Receiving Providers</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('receivingProvidersChart', 'receiving-providers')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="receivingProvidersChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provider Collaboration Network -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-project-diagram me-1"></i>Provider Collaboration Network</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('collaborationTable', 'provider-collaboration')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-sm table-hover mb-0" id="collaborationTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>From (Sending Provider)</th>
                                            <th><i class="fas fa-arrow-right"></i></th>
                                            <th>To (Receiving Provider)</th>
                                            <th class="text-end">Referrals</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Referral Flow (Sankey Diagram) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0"><i class="fas fa-exchange-alt me-1"></i>Patient Referral Flow</h6>
                                <small class="text-muted">Visualizing patient movement between providers (accepted/completed referrals only)</small>
                            </div>
                            <div>
                                <label class="me-2" style="font-size: 0.9rem;">Min. Referrals:</label>
                                <input type="number" id="sankeyMinReferrals" class="form-control form-control-sm d-inline-block" 
                                       style="width: 80px;" value="5" min="1" max="100" onchange="loadReferralFlowSankey()">
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="referralFlowSankey" style="height: 600px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Programs -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-star me-1"></i>Top Programs by Referrals</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('topProgramsTable', 'top-programs')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0" id="topProgramsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Program Name</th>
                                            <th class="text-end">Referrals</th>
                                            <th class="text-end">Accepted</th>
                                            <th class="text-end">Acceptance %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== PERFORMANCE TAB ========== -->
        <div class="tab-pane fade" id="performance" role="tabpanel">
            
            <!-- Employee Workload -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-user-tie me-1"></i>Employee Workload & Performance</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('workloadTable', 'employee-workload')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-sm table-hover mb-0" id="workloadTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Employee</th>
                                            <th>Provider</th>
                                            <th class="text-end">Active Cases</th>
                                            <th class="text-end">Total Cases</th>
                                            <th class="text-end">Resolved</th>
                                            <th class="text-end">Resolution %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Journey Metrics -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-route me-1"></i>Client Journey Metrics</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Total Clients:</span>
                                    <strong id="journeyTotalClients">-</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Avg Cases per Client:</span>
                                    <strong id="journeyAvgCases">-</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Avg Referrals per Client:</span>
                                    <strong id="journeyAvgReferrals">-</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Avg Assistance Requests:</span>
                                    <strong id="journeyAvgAR">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-handshake me-1"></i>Client Touchpoint Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('touchpointChart', 'client-touchpoints')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="touchpointChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cases Over Time by Status -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-chart-area me-1"></i>Cases Over Time (by Status)</h6>
                            <div>
                                <select class="form-select form-select-sm d-inline-block w-auto me-2" id="casesTimeGrouping">
                                    <option value="day">Daily</option>
                                    <option value="week">Weekly</option>
                                    <option value="month" selected>Monthly</option>
                                </select>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChart('casesOverTimeChart', 'cases-over-time')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="casesOverTimeChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== OUTCOMES TAB ========== -->
        <div class="tab-pane fade" id="outcomes" role="tabpanel">
            
            <!-- Referral Funnel with Drop-Off Analysis -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center bg-gradient" 
                             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-filter me-2"></i>Client Referral Funnel
                            </h6>
                            <button class="btn btn-sm btn-light" onclick="exportChart('referralFunnelChart', 'referral-funnel')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px; position: relative;">
                                <canvas id="referralFunnelChart"></canvas>
                            </div>
                            <div class="mt-3 text-center">
                                <span class="badge bg-success me-2">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Completion Rate: <span id="completionRate">--</span>%
                                </span>
                                <span class="badge bg-info">
                                    <i class="fas fa-handshake me-1"></i>
                                    Acceptance Rate: <span id="acceptanceRate">--</span>%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Drop-Off Reasons
                            </h6>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px; position: relative;">
                                <canvas id="dropOffReasonsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timing Analysis -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Referral Process Timing Analysis
                            </h6>
                            <button class="btn btn-sm btn-light" onclick="exportChart('timingAnalysisChart', 'timing-analysis')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div style="height: 200px; position: relative;">
                                <canvas id="timingAnalysisChart"></canvas>
                            </div>
                            <div id="timingStats" class="mt-3 row text-center"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provider Performance & High-Risk Services -->
            <div class="row mb-4">
                <div class="col-md-7">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <i class="fas fa-hospital me-2"></i>Provider Performance Metrics
                                </h6>
                                <small class="text-muted">Top providers by referral volume</small>
                            </div>
                            <div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <input type="radio" class="btn-check" name="providerType" id="receivingProviders" value="receiving" checked>
                                    <label class="btn btn-outline-primary" for="receivingProviders">Receiving</label>
                                    
                                    <input type="radio" class="btn-check" name="providerType" id="sendingProviders" value="sending">
                                    <label class="btn btn-outline-primary" for="sendingProviders">Sending</label>
                                </div>
                                <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('providerMetricsTable', 'provider-metrics')">
                                    <i class="fas fa-file-csv"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="providerMetricsTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Provider</th>
                                            <th class="text-end" title="Total Referrals">Total</th>
                                            <th class="text-end" title="Acceptance Rate">Accept %</th>
                                            <th class="text-end" title="Completion Rate">Complete %</th>
                                            <th class="text-end" title="Average Response Days">Avg Days</th>
                                        </tr>
                                    </thead>
                                    <tbody id="providerMetricsBody">
                                        <tr><td colspan="5" class="text-center text-muted py-3">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                                        </td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-circle me-2"></i>High-Risk Service Types
                            </h6>
                            <small>Services with highest drop-off rates</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="highRiskTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Service Type</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-end">Drop %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="highRiskBody">
                                        <tr><td colspan="3" class="text-center text-muted py-3">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                                        </td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Journey Stages -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-route me-2"></i>Client Journey Status Distribution
                            </h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('journeyStagesChart', 'journey-stages')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div style="height: 150px; position: relative;">
                                <canvas id="journeyStagesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outcome Metrics -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-1"></i>Resolution Types</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('resolutionTypesChart', 'resolution-types')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="resolutionTypesChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-stopwatch me-1"></i>Avg Resolution Time by Service</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('resolutionByServiceChart', 'resolution-by-service')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="resolutionByServiceChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provider Performance Leaderboard -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center bg-gradient" 
                             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-trophy me-2"></i>Service Provider Leaderboard
                            </h6>
                            <button class="btn btn-sm btn-light" onclick="exportTableToCSV('providerPerfTable', 'provider-leaderboard')">
                                <i class="fas fa-file-csv me-1"></i>Export CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                                <table class="table table-hover mb-0" id="providerPerfTable">
                                    <thead class="table-light sticky-top" style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <tr>
                                            <th style="width: 50px;" class="text-center">
                                                <i class="fas fa-medal text-warning"></i> Rank
                                            </th>
                                            <th>Provider Name</th>
                                            <th class="text-end">
                                                <i class="fas fa-folder-open text-primary me-1"></i>Total Cases
                                            </th>
                                            <th class="text-end">
                                                <i class="fas fa-clock text-warning me-1"></i>Pending
                                            </th>
                                            <th class="text-end">
                                                <i class="fas fa-chart-line text-info me-1"></i>Avg Days
                                            </th>
                                            <th class="text-end">
                                                <i class="fas fa-arrow-down text-success me-1"></i>Min Days
                                            </th>
                                            <th class="text-end">
                                                <i class="fas fa-arrow-up text-danger me-1"></i>Max Days
                                            </th>
                                            <th class="text-end">
                                                <i class="fas fa-check-circle text-success me-1"></i>Completion %
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="providerLeaderboardBody" class="text-dark">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Loading leaderboard...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Providers with at least 5 cases. Sorted by total cases (descending), then average days (ascending).
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Pathways -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-route me-1"></i>Common Service Pathways</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('pathwaysTable', 'service-pathways')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-hover mb-0" id="pathwaysTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Initial Service</th>
                                            <th><i class="fas fa-arrow-right"></i></th>
                                            <th>Referral Service</th>
                                            <th class="text-end">Count</th>
                                            <th class="text-end">Avg Days Between</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== GEOGRAPHIC TAB ========== -->
        <div class="tab-pane fade" id="geographic" role="tabpanel">
            
            <!-- Geographic Overview Cards -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-city me-1"></i>Cases by City (Top 15)</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('citiesChart', 'cases-by-city')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="citiesChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-map me-1"></i>Cases by County</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('countiesChart', 'cases-by-county')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="countiesChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-mail-bulk me-1"></i>Cases by ZIP Code (Top 15)</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('zipTable', 'cases-by-zip')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-hover mb-0" id="zipTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>ZIP Code</th>
                                            <th class="text-end">Case Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="2" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== ADVANCED TAB ========== -->
        <div class="tab-pane fade" id="advanced" role="tabpanel">
            
            <!-- Cohort Analysis -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-users-cog me-1"></i>Client Cohort Analysis</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('cohortChart', 'cohort-analysis')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="cohortChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Network Visualization -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-project-diagram me-1"></i>Referral Network (Top Connections)</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('networkTable', 'referral-network')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-sm table-hover mb-0" id="networkTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Source Provider</th>
                                            <th><i class="fas fa-arrow-right"></i></th>
                                            <th>Target Provider</th>
                                            <th class="text-end">Referrals</th>
                                            <th class="text-end">Unique Clients</th>
                                            <th class="text-end">Acceptance %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demographic Correlations -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-1"></i>Housing Status Impact</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('housingChart', 'housing-impact')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="housingChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-home me-1"></i>Household Size Distribution</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('householdSizeChart', 'household-size')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="householdSizeChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Series -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-1"></i>Referrals Time Series</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChart('referralsTimeChart', 'referrals-time-series')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="referralsTimeChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export to Word Modal -->
<div class="modal fade" id="exportWordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-word me-2"></i>Export Charts to Word</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Select the charts you want to include in the Word document:</p>
                <div class="row g-2" id="exportChartsList">
                    <!-- Overview Charts -->
                    <div class="col-12"><strong class="text-primary">Overview</strong></div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_referralStatus" data-chart-id="referralStatus">
                            <label class="form-check-label" for="export_referralStatus">Referral Status</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_caseStatus" data-chart-id="caseStatus">
                            <label class="form-check-label" for="export_caseStatus">Case Status</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_serviceType" data-chart-id="serviceType">
                            <label class="form-check-label" for="export_serviceType">Service Types</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_timeline" data-chart-id="timeline">
                            <label class="form-check-label" for="export_timeline">Referrals Timeline</label>
                        </div>
                    </div>
                    
                    <!-- Demographics Charts -->
                    <div class="col-12 mt-3"><strong class="text-primary">Demographics</strong></div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_ageDist" data-chart-id="ageDist">
                            <label class="form-check-label" for="export_ageDist">Age Distribution</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_gender" data-chart-id="gender">
                            <label class="form-check-label" for="export_gender">Gender Distribution</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_race" data-chart-id="race">
                            <label class="form-check-label" for="export_race">Race/Ethnicity</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_household" data-chart-id="household">
                            <label class="form-check-label" for="export_household">Household Composition</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_householdScatter" data-chart-id="householdScatter">
                            <label class="form-check-label" for="export_householdScatter">Household Size Analysis</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_income" data-chart-id="income">
                            <label class="form-check-label" for="export_income">Income Distribution</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_insurance" data-chart-id="insurance">
                            <label class="form-check-label" for="export_insurance">Insurance Status</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_commPref" data-chart-id="commPref">
                            <label class="form-check-label" for="export_commPref">Communication Preferences</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_marital" data-chart-id="marital">
                            <label class="form-check-label" for="export_marital">Marital Status</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_language" data-chart-id="language">
                            <label class="form-check-label" for="export_language">Language Distribution</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_milAff" data-chart-id="milAff">
                            <label class="form-check-label" for="export_milAff">Military Affiliation</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_milBranch" data-chart-id="milBranch">
                            <label class="form-check-label" for="export_milBranch">Military Branch</label>
                        </div>
                    </div>
                    
                    <!-- Network & Providers -->
                    <div class="col-12 mt-3"><strong class="text-primary">Network & Providers</strong></div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_sendingProviders" data-chart-id="sendingProviders">
                            <label class="form-check-label" for="export_sendingProviders">Top Sending Providers</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_receivingProviders" data-chart-id="receivingProviders">
                            <label class="form-check-label" for="export_receivingProviders">Top Receiving Providers</label>
                        </div>
                    </div>
                    
                    <!-- Performance & Outcomes -->
                    <div class="col-12 mt-3"><strong class="text-primary">Performance & Outcomes</strong></div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_touchpoint" data-chart-id="touchpoint">
                            <label class="form-check-label" for="export_touchpoint">Touchpoint Distribution</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_casesOverTime" data-chart-id="casesOverTime">
                            <label class="form-check-label" for="export_casesOverTime">Cases Over Time</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input export-chart-checkbox" type="checkbox" checked id="export_referralFunnel" data-chart-id="referralFunnel">
                            <label class="form-check-label" for="export_referralFunnel">Referral Funnel</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="selectAllExportCharts()">Select All</button>
                <button type="button" class="btn btn-outline-secondary" onclick="deselectAllExportCharts()">Deselect All</button>
                <span class="badge bg-info me-auto"><span id="exportSelectedCount">0</span> selected</span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="exportSelectedChartsToWord()" id="exportWordBtn">
                    <i class="fas fa-download me-1"></i>Export to Word
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Global Filters Modal -->
<div class="modal fade" id="globalFiltersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Global Report Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <!-- Date Range -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Start Date</label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">End Date</label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>

                    <!-- Case Status -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Case Status</label>
                        <select class="form-select" id="filterCaseStatus">
                            <option value="">All Statuses</option>
                        </select>
                    </div>

                    <!-- Service Type -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Service Type</label>
                        <select class="form-select" id="filterServiceType">
                            <option value="">All Services</option>
                        </select>
                    </div>

                    <!-- Provider -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Provider</label>
                        <select class="form-select" id="filterProvider">
                            <option value="">All Providers</option>
                        </select>
                    </div>

                    <!-- Program -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Program</label>
                        <select class="form-select" id="filterProgram">
                            <option value="">All Programs</option>
                        </select>
                    </div>

                    <!-- Gender -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Gender</label>
                        <select class="form-select" id="filterGender">
                            <option value="">All Genders</option>
                        </select>
                    </div>

                    <!-- Race -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Race/Ethnicity</label>
                        <select class="form-select" id="filterRace">
                            <option value="">All Races</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                <button type="button" class="btn btn-primary" onclick="applyGlobalFilters()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

<!-- Preload Dashboard Resources -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" as="script" crossorigin>
<link rel="preload" href="https://cdn.plot.ly/plotly-2.27.0.min.js" as="script" crossorigin>
<link rel="preload" href="/static/js/main.js" as="script">
<link rel="preload" href="/static/js/charts/overview.js" as="script">
<link rel="preload" href="/static/js/charts/demographics.js" as="script">
<link rel="preload" href="/static/js/reports/performance.js" as="script">

<!-- Chart.js Library - Load with defer -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer crossorigin></script>

<!-- Plotly.js for Sankey Diagrams - Load with defer -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" defer crossorigin></script>

<!-- Dashboard Modules - Load with defer -->
<script type="module" src="/static/js/main.js" defer></script>

<script>

let charts = {};

// Cleanup all charts on page unload to prevent memory leaks
window.addEventListener('beforeunload', function() {
    for (const chartName in charts) {
        if (charts[chartName] && typeof charts[chartName].destroy === 'function') {
            try {
                charts[chartName].destroy();
            } catch (e) {
                console.warn(`Error destroying chart ${chartName}:`, e);
            }
        }
    }
    charts = {};
});

// Chart color palettes
const colorSchemes = {
    primary: ['#2c5282', '#3182ce', '#4299e1', '#63b3ed', '#90cdf4', '#bee3f8'],
    success: ['#22543d', '#276749', '#2f855a', '#38a169', '#48bb78', '#68d391'],
    warm: ['#c05621', '#dd6b20', '#ed8936', '#f6ad55', '#fbd38d', '#feebc8'],
    diverse: ['#2c5282', '#38a169', '#dd6b20', '#805ad5', '#d53f8c', '#319795', '#e53e3e', '#f6ad55']
};

// Update quick filter button labels based on current date
function updateQuickFilterLabels() {
    const now = new Date();
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    const quarterNames = ['Q1', 'Q2', 'Q3', 'Q4'];
    
    // This Month
    const thisMonthElem = document.getElementById('quickFilterThisMonth');
    if (thisMonthElem) {
        thisMonthElem.textContent = `This Month (${monthNames[now.getMonth()]})`;
    }
    
    // Last Month
    const lastMonthElem = document.getElementById('quickFilterLastMonth');
    if (lastMonthElem) {
        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        lastMonthElem.textContent = `Last Month (${monthNames[lastMonthDate.getMonth()]})`;
    }
    
    // This Quarter
    const thisQuarterElem = document.getElementById('quickFilterThisQuarter');
    if (thisQuarterElem) {
        const currentQuarter = Math.floor(now.getMonth() / 3);
        thisQuarterElem.textContent = `This Quarter (${quarterNames[currentQuarter]})`;
    }
    
    // Last Quarter
    const lastQuarterElem = document.getElementById('quickFilterLastQuarter');
    if (lastQuarterElem) {
        const currentQuarter = Math.floor(now.getMonth() / 3);
        const lastQuarter = currentQuarter === 0 ? 3 : currentQuarter - 1;
        lastQuarterElem.textContent = `Last Quarter (${quarterNames[lastQuarter]})`;
    }
    
    // This Year
    const thisYearElem = document.getElementById('quickFilterThisYear');
    if (thisYearElem) {
        thisYearElem.textContent = `This Year (${now.getFullYear()})`;
    }
    
    // Last Year
    const lastYearElem = document.getElementById('quickFilterLastYear');
    if (lastYearElem) {
        lastYearElem.textContent = `Last Year (${now.getFullYear() - 1})`;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if ChartDataLabels is available
    if (typeof ChartDataLabels === 'undefined') {
        console.error('ChartDataLabels plugin not loaded! Check CDN connection.');
    } else {
        console.log('ChartDataLabels plugin loaded successfully');
    }
    
    updateQuickFilterLabels();
    loadFilterOptions();
    loadOverviewReports();
    
    // Tab change listeners
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('data-bs-target');
            if (targetId === '#demographics') {
                loadDemographicsReports();
            } else if (targetId === '#services') {
                loadServicesReports();
            } else if (targetId === '#network') {
                loadNetworkReports();
            } else if (targetId === '#performance') {
                loadPerformanceReports();
            } else if (targetId === '#outcomes') {
                loadOutcomesReports();
            } else if (targetId === '#geographic') {
                loadGeographicReports();
            } else if (targetId === '#advanced') {
                loadAdvancedReports();
            }
        });
    });
    
    // Event listeners
    document.getElementById('timelineGrouping').addEventListener('change', loadTimelineChart);
    document.getElementById('casesTimeGrouping').addEventListener('change', loadCasesOverTimeChart);
    
    // Provider type toggle for outcomes tab
    document.querySelectorAll('input[name="providerType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            loadProviderPerformanceMetrics();
        });
    });
});

// Global filters state
let globalFilters = {
    startDate: null,
    endDate: null,
    caseStatus: null,
    serviceType: null,
    provider: null,
    program: null,
    gender: null,
    race: null
};

async function loadFilterOptions() {
    try {
        const response = await cachedFetch('/api/reports/filter-options', {}, 120000); // Cache for 2 minutes (session-based)
        const options = await response.json();
        
        // Populate filter dropdowns
        if (options.case_statuses) {
            const select = document.getElementById('filterCaseStatus');
            options.case_statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                select.appendChild(option);
            });
        }
        
        if (options.service_types) {
            const select = document.getElementById('filterServiceType');
            options.service_types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }
        
        if (options.providers) {
            const select = document.getElementById('filterProvider');
            options.providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider;
                option.textContent = provider;
                select.appendChild(option);
            });
        }
        
        if (options.programs) {
            const select = document.getElementById('filterProgram');
            options.programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                select.appendChild(option);
            });
        }
        
        if (options.genders) {
            const select = document.getElementById('filterGender');
            options.genders.forEach(gender => {
                const option = document.createElement('option');
                option.value = gender;
                option.textContent = gender;
                select.appendChild(option);
            });
        }
        
        if (options.races) {
            const select = document.getElementById('filterRace');
            options.races.forEach(race => {
                const option = document.createElement('option');
                option.value = race;
                option.textContent = race;
                select.appendChild(option);
            });
        }
        
        // Set default date range if available
        if (options.date_range && options.date_range.min && options.date_range.max) {
            document.getElementById('filterStartDate').value = options.date_range.min.split('T')[0];
            document.getElementById('filterEndDate').value = options.date_range.max.split('T')[0];
        }
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

function applyGlobalFilters() {
    globalFilters = {
        startDate: document.getElementById('filterStartDate').value || null,
        endDate: document.getElementById('filterEndDate').value || null,
        caseStatus: document.getElementById('filterCaseStatus').value || null,
        serviceType: document.getElementById('filterServiceType').value || null,
        provider: document.getElementById('filterProvider').value || null,
        program: document.getElementById('filterProgram').value || null,
        gender: document.getElementById('filterGender').value || null,
        race: document.getElementById('filterRace').value || null
    };
    
    // Clear API cache when filters change (new data needed)
    if (typeof clearApiCache === 'function') {
        clearApiCache('/api/reports/');
    }
    
    // Clear quick filter highlight when user applies custom filters
    clearActiveQuickFilter();
    
    // Update active filters display
    updateActiveFiltersBadges();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('globalFiltersModal'));
    modal.hide();
    
    // Reload current tab data
    reloadCurrentTabData();
}

function clearAllFilters() {
    globalFilters = {
        startDate: null,
        endDate: null,
        caseStatus: null,
        serviceType: null,
        provider: null,
        program: null,
        gender: null,
        race: null
    };
    
    // Clear form inputs
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    document.getElementById('filterCaseStatus').value = '';
    document.getElementById('filterServiceType').value = '';
    document.getElementById('filterProvider').value = '';
    document.getElementById('filterProgram').value = '';
    document.getElementById('filterGender').value = '';
    document.getElementById('filterRace').value = '';
    
    // Clear active quick filter highlight
    clearActiveQuickFilter();
    
    updateActiveFiltersBadges();
    reloadCurrentTabData();
}

function updateActiveFiltersBadges() {
    const container = document.getElementById('activeFiltersBadges');
    container.innerHTML = '';
    
    const activeFilters = [];
    if (globalFilters.startDate) activeFilters.push({key: 'startDate', label: `Start: ${globalFilters.startDate}`});
    if (globalFilters.endDate) activeFilters.push({key: 'endDate', label: `End: ${globalFilters.endDate}`});
    if (globalFilters.caseStatus) activeFilters.push({key: 'caseStatus', label: `Status: ${globalFilters.caseStatus}`});
    if (globalFilters.serviceType) activeFilters.push({key: 'serviceType', label: `Service: ${globalFilters.serviceType}`});
    if (globalFilters.provider) activeFilters.push({key: 'provider', label: `Provider: ${globalFilters.provider}`});
    if (globalFilters.program) activeFilters.push({key: 'program', label: `Program: ${globalFilters.program}`});
    if (globalFilters.gender) activeFilters.push({key: 'gender', label: `Gender: ${globalFilters.gender}`});
    if (globalFilters.race) activeFilters.push({key: 'race', label: `Race: ${globalFilters.race}`});
    
    if (activeFilters.length > 0) {
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-wrap gap-2 align-items-center';
        
        const label = document.createElement('small');
        label.className = 'text-muted fw-bold';
        label.textContent = 'Active Filters:';
        wrapper.appendChild(label);
        
        activeFilters.forEach(filter => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary d-inline-flex align-items-center gap-1';
            badge.style.cursor = 'pointer';
            badge.innerHTML = `
                ${filter.label}
                <i class="fas fa-times" onclick="removeFilter('${filter.key}')" style="cursor: pointer;" title="Remove filter"></i>
            `;
            wrapper.appendChild(badge);
        });
        
        container.appendChild(wrapper);
    }
}

// Helper function to safely create charts with proper error handling
function createChartSafely(canvasId, chartName, chartConfig) {
    return new Promise((resolve, reject) => {
        try {
            const canvas = document.getElementById(canvasId);
            
            // Validate canvas exists
            if (!canvas) {
                console.error(`[createChartSafely] Canvas element '${canvasId}' not found in DOM`);
                reject(new Error(`Canvas ${canvasId} not found`));
                return;
            }
            
            // Validate canvas has dimensions (critical for Chart.js)
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                console.warn(`[createChartSafely] Canvas '${canvasId}' has zero dimensions (${rect.width}x${rect.height}). Parent may be hidden.`);
                // Don't reject - canvas might be in hidden tab, which is OK
                resolve(null);
                return;
            }
            
            // Validate chart data
            if (chartConfig.data && chartConfig.data.datasets) {
                const dataset = chartConfig.data.datasets[0];
                if (dataset && dataset.data) {
                    const hasValidData = dataset.data.some(v => v != null && v > 0);
                    if (!hasValidData) {
                        console.warn(`[createChartSafely] Chart '${chartName}' has no valid data to display`);
                    }
                }
            }
            
            // Destroy existing chart if it exists
            if (charts[chartName]) {
                try {
                    console.log(`[createChartSafely] Destroying existing chart: ${chartName}`);
                    charts[chartName].destroy();
                } catch (e) {
                    console.warn(`[createChartSafely] Error destroying chart ${chartName}:`, e);
                }
            }
            
            // Use requestAnimationFrame to ensure DOM is fully rendered
            requestAnimationFrame(() => {
                try {
                    console.log(`[createChartSafely] Creating chart: ${chartName} on canvas ${canvasId}`);
                    charts[chartName] = new Chart(canvas, chartConfig);
                    console.log(`[createChartSafely]  Chart ${chartName} created successfully`);
                    resolve(charts[chartName]);
                } catch (error) {
                    console.error(`[createChartSafely]  Failed to create chart ${chartName}:`, error);
                    console.error(`[createChartSafely] Canvas dimensions: ${rect.width}x${rect.height}`);
                    console.error(`[createChartSafely] Chart config:`, chartConfig);
                    reject(error);
                }
            });
            
        } catch (error) {
            console.error(`[createChartSafely] Unexpected error for chart ${chartName}:`, error);
            reject(error);
        }
    });
}

// Helper function to validate chart data structure
function validateChartData(data, chartName) {
    if (!data) {
        console.error(`[validateChartData] ${chartName}: data is null or undefined`);
        return false;
    }
    
    if (!data.labels || !Array.isArray(data.labels)) {
        console.error(`[validateChartData] ${chartName}: missing or invalid labels array`);
        return false;
    }
    
    if (!data.values || !Array.isArray(data.values)) {
        console.error(`[validateChartData] ${chartName}: missing or invalid values array`);
        return false;
    }
    
    if (data.labels.length !== data.values.length) {
        console.error(`[validateChartData] ${chartName}: labels (${data.labels.length}) and values (${data.values.length}) length mismatch`);
        return false;
    }
    
    if (data.labels.length === 0) {
        console.warn(`[validateChartData] ${chartName}: empty data arrays`);
        return false;
    }
    
    // Check for non-numeric values
    const invalidValues = data.values.filter(v => typeof v !== 'number' && v !== null);
    if (invalidValues.length > 0) {
        console.error(`[validateChartData] ${chartName}: non-numeric values found:`, invalidValues);
        return false;
    }
    
    console.log(`[validateChartData]  ${chartName}: data is valid (${data.labels.length} items)`);
    return true;
}

// Safe datalabels formatter with comprehensive null checks
function createDatalabelsFormatter() {
    return function(value, context) {
        try {
            // Validate context - be extra defensive
            if (!context) return '';
            if (!context.chart) return '';
            if (!context.chart.data) return '';
            if (!context.chart.data.datasets) return '';
            if (!context.chart.data.datasets[0]) return '';
            
            const dataset = context.chart.data.datasets[0];
            if (!dataset.data || !Array.isArray(dataset.data)) return '';
            
            const arr = dataset.data;
            const sum = arr.reduce((a, b) => (a || 0) + (b || 0), 0) || 0;
            
            // Don't display labels for zero or null values
            if (value == null || value === 0 || sum === 0) {
                return '';
            }
            
            // Validate we can calculate percentage
            if (typeof value !== 'number' || typeof sum !== 'number') return '';
            
            const percentage = ((value / sum) * 100).toFixed(1) + '%';
            const count = Number(value).toLocaleString();
            
            // Return two-line label: percentage and count
            return [percentage, `n=${count}`];
        } catch (error) {
            // Silently fail - don't log to avoid console spam
            return '';
        }
    };
}

function removeFilter(filterKey) {
    globalFilters[filterKey] = null;
    
    // Clear the corresponding form input
    const inputMap = {
        'startDate': 'filterStartDate',
        'endDate': 'filterEndDate',
        'caseStatus': 'filterCaseStatus',
        'serviceType': 'filterServiceType',
        'provider': 'filterProvider',
        'program': 'filterProgram',
        'gender': 'filterGender',
        'race': 'filterRace'
    };
    
    const inputId = inputMap[filterKey];
    if (inputId) {
        const input = document.getElementById(inputId);
        if (input) input.value = '';
    }
    
    updateActiveFiltersBadges();
    reloadCurrentTabData();
}

function clearActiveQuickFilter() {
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'btn-primary');
        btn.classList.add('btn-outline-secondary');
    });
}

function applyQuickFilter(filterType) {
    // Clear API cache when filters change (new data needed)
    if (typeof clearApiCache === 'function') {
        clearApiCache('/api/reports/');
    }
    const now = new Date();
    let startDate, endDate;
    
    // Calculate date ranges based on filter type
    switch(filterType) {
        case 'thisMonth':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            break;
        case 'lastMonth':
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
        case 'last30Days':
            startDate = new Date(now);
            startDate.setDate(now.getDate() - 30);
            endDate = now;
            break;
        case 'thisQuarter':
            const currentQuarter = Math.floor(now.getMonth() / 3);
            startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
            endDate = new Date(now.getFullYear(), (currentQuarter + 1) * 3, 0);
            break;
        case 'lastQuarter':
            const lastQuarter = Math.floor(now.getMonth() / 3) - 1;
            const year = lastQuarter < 0 ? now.getFullYear() - 1 : now.getFullYear();
            const quarter = lastQuarter < 0 ? 3 : lastQuarter;
            startDate = new Date(year, quarter * 3, 1);
            endDate = new Date(year, (quarter + 1) * 3, 0);
            break;
        case 'thisYear':
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31);
            break;
        case 'lastYear':
            startDate = new Date(now.getFullYear() - 1, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31);
            break;
    }
    
    // Format dates as YYYY-MM-DD
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // Update global filters
    globalFilters.startDate = formatDate(startDate);
    globalFilters.endDate = formatDate(endDate);
    
    // Update form inputs
    document.getElementById('filterStartDate').value = globalFilters.startDate;
    document.getElementById('filterEndDate').value = globalFilters.endDate;
    
    // Highlight active quick filter button
    clearActiveQuickFilter();
    const activeBtn = document.querySelector(`.quick-filter-btn[data-filter="${filterType}"]`);
    if (activeBtn) {
        activeBtn.classList.remove('btn-outline-secondary');
        activeBtn.classList.add('btn-primary', 'active');
    }
    
    updateActiveFiltersBadges();
    reloadCurrentTabData();
}

function reloadCurrentTabData() {
    // Determine which tab is currently active and reload its data
    const activeTab = document.querySelector('.nav-link.active');
    if (!activeTab) {
        loadOverviewReports(); // Default to overview
        return;
    }
    
    const targetId = activeTab.getAttribute('data-bs-target');
    
    if (targetId === '#overview' || !targetId) {
        loadOverviewReports();
    } else if (targetId === '#demographics') {
        loadDemographicsReports();
    } else if (targetId === '#services') {
        loadServicesReports();
    } else if (targetId === '#network') {
        loadNetworkReports();
    } else if (targetId === '#performance') {
        loadPerformanceReports();
    } else if (targetId === '#outcomes') {
        loadOutcomesReports();
    } else if (targetId === '#geographic') {
        loadGeographicReports();
    } else if (targetId === '#advanced') {
        loadAdvancedReports();
    }
}

function buildFilterQueryString() {
    const params = new URLSearchParams();
    
    if (globalFilters.startDate) params.append('start_date', globalFilters.startDate);
    if (globalFilters.endDate) params.append('end_date', globalFilters.endDate);
    if (globalFilters.caseStatus) params.append('case_status', globalFilters.caseStatus);
    if (globalFilters.serviceType) params.append('service_type', globalFilters.serviceType);
    if (globalFilters.provider) params.append('provider', globalFilters.provider);
    if (globalFilters.program) params.append('program', globalFilters.program);
    if (globalFilters.gender) params.append('gender', globalFilters.gender);
    if (globalFilters.race) params.append('race', globalFilters.race);
    
    const queryString = params.toString();
    return queryString ? '?' + queryString : '';
}

async function loadReferralStatusChart() {
    const chartName = 'referralStatus';
    const canvasId = 'referralStatusChart';
    
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/referral-status' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);

        // Validate data structure
        if (!validateChartData(data, chartName)) {
            console.warn(`[${chartName}] Invalid data, showing "No Data" chart`);
            
            // Create "No Data" chart
            const noDataConfig = {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{ 
                        data: [1], 
                        backgroundColor: ['#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right' }, 
                        tooltip: { enabled: false }, 
                        datalabels: { display: false }
                    }
                }
            };
            
            await createChartSafely(canvasId, chartName, noDataConfig);
            return;
        }

        // Create chart with valid data
        const chartConfig = {
            type: 'doughnut',
            data: { 
                labels: data.labels, 
                datasets: [{ 
                    data: data.values, 
                    backgroundColor: colorSchemes.diverse,
                    borderWidth: 2,
                    borderColor: '#fff'
                }] 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0  // Disable animations to prevent race conditions
                },
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: {
                            padding: 10,
                            font: { size: 12 }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#fff',
                        font: { weight: 'bold', size: 13 },
                        formatter: createDatalabelsFormatter(),
                        // Add listeners to catch rendering errors
                        listeners: {
                            enter: function(context) {
                                // Only show label if context is valid
                                return context && context.chart && context.chart.ctx;
                            }
                        }
                    }
                }
            },
            plugins: [window.ChartDataLabels]  // Use window.ChartDataLabels to ensure it's found
        };
        
        await createChartSafely(canvasId, chartName, chartConfig);
        console.log(`[${chartName}]  Chart loaded successfully`);
        
    } catch (error) { 
        console.error(`[${chartName}]  Error loading chart:`, error);
        console.error(`[${chartName}] Stack trace:`, error.stack);
    }
}

async function loadOverviewReports() {
    await Promise.all([
        loadSummaryCards(),
        loadReferralStatusChart(),
        loadCaseStatusChart(),
        loadServiceTypeChart(),
        loadTimelineChart()
    ]);
}

async function loadSummaryCards() {
    try {
        const response = await cachedFetch('/api/reports/summary' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
        const data = await response.json();
        
        // Display actual values from the API
        document.getElementById('totalReferrals').textContent = (data.total_referrals !== undefined && data.total_referrals !== null) ? data.total_referrals.toLocaleString() : 'N/A';
        document.getElementById('totalCases').textContent = (data.total_cases !== undefined && data.total_cases !== null) ? data.total_cases.toLocaleString() : 'N/A';
        document.getElementById('totalPeople').textContent = (data.total_people !== undefined && data.total_people !== null) ? data.total_people.toLocaleString() : 'N/A';
        document.getElementById('totalAssistance').textContent = (data.total_assistance_requests !== undefined && data.total_assistance_requests !== null) ? data.total_assistance_requests.toLocaleString() : 'N/A';
    } catch (error) {
        console.error('Error loading summary cards:', error);
        // Display error state instead of fake zeros
        document.getElementById('totalReferrals').textContent = 'Error';
        document.getElementById('totalCases').textContent = 'Error';
        document.getElementById('totalPeople').textContent = 'Error';
        document.getElementById('totalAssistance').textContent = 'Error';
    }
}

async function loadCaseStatusChart() {
    const chartName = 'caseStatus';
    const canvasId = 'caseStatusChart';
    
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/case-status' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);

        // Validate data structure
        if (!validateChartData(data, chartName)) {
            console.warn(`[${chartName}] Invalid data, showing "No Data" chart`);
            
            // Create "No Data" chart
            const noDataConfig = {
                type: 'pie',
                data: {
                    labels: ['No Data'],
                    datasets: [{ 
                        data: [1], 
                        backgroundColor: ['#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right' }, 
                        tooltip: { enabled: false }, 
                        datalabels: { display: false }
                    }
                }
            };
            
            await createChartSafely(canvasId, chartName, noDataConfig);
            return;
        }

        // Create chart with valid data
        const chartConfig = {
            type: 'pie',
            data: { 
                labels: data.labels, 
                datasets: [{ 
                    data: data.values, 
                    backgroundColor: colorSchemes.diverse,
                    borderWidth: 2,
                    borderColor: '#fff'
                }] 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0  // Disable animations to prevent race conditions
                },
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: {
                            padding: 10,
                            font: { size: 12 }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#fff',
                        font: { weight: 'bold', size: 13 },
                        formatter: createDatalabelsFormatter(),
                        listeners: {
                            enter: function(context) {
                                return context && context.chart && context.chart.ctx;
                            }
                        }
                    }
                }
            },
            plugins: [window.ChartDataLabels]  // Use window.ChartDataLabels to ensure it's found
        };
        
        await createChartSafely(canvasId, chartName, chartConfig);
        console.log(`[${chartName}]  Chart loaded successfully`);
        
    } catch (error) { 
        console.error(`[${chartName}]  Error loading chart:`, error);
        console.error(`[${chartName}] Stack trace:`, error.stack);
    }
}

async function loadServiceTypeChart() {
    const chartName = 'serviceType';
    const canvasId = 'serviceTypeChart';
    
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/service-types' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);

        // Validate data structure
        if (!validateChartData(data, chartName)) {
            console.warn(`[${chartName}] Invalid data, showing "No Data" chart`);
            
            const noDataConfig = {
                type: 'bar',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        label: 'Cases',
                        data: [0],
                        backgroundColor: '#e0e0e0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false }, datalabels: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            };
            
            await createChartSafely(canvasId, chartName, noDataConfig);
            return;
        }
        
        const chartConfig = {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Cases',
                    data: data.values,
                    backgroundColor: colorSchemes.primary[0]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value ? value.toLocaleString() : ''
                    }
                },
                scales: { x: { beginAtZero: true } }
            },
            plugins: [window.ChartDataLabels]  // Use window.ChartDataLabels
        };
        
        await createChartSafely(canvasId, chartName, chartConfig);
        console.log(`[${chartName}]  Chart loaded successfully`);
        
    } catch (error) {
        console.error(`[${chartName}]  Error loading chart:`, error);
        console.error(`[${chartName}] Stack trace:`, error.stack);
    }
}

async function loadTimelineChart() {
    const chartName = 'timeline';
    const canvasId = 'timelineChart';
    
    try {
        const grouping = document.getElementById('timelineGrouping').value;
        const filterString = buildFilterQueryString();
        const separator = filterString ? '&' : '?';
        
        console.log(`[${chartName}] Fetching data...`);
        const response = await fetch(`/api/reports/referrals-timeline?grouping=${grouping}${filterString ? separator + filterString.substring(1) : ''}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);

        // Validate data structure
        if (!validateChartData(data, chartName)) {
            console.warn(`[${chartName}] Invalid data, showing "No Data" chart`);
            
            const noDataConfig = {
                type: 'line',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        label: 'Referrals',
                        data: [0],
                        borderColor: '#e0e0e0',
                        backgroundColor: 'rgba(224, 224, 224, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { datalabels: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            };
            
            await createChartSafely(canvasId, chartName, noDataConfig);
            return;
        }
        
        const chartConfig = {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Referrals',
                    data: data.values,
                    borderColor: colorSchemes.primary[0],
                    backgroundColor: 'rgba(44, 82, 130, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { datalabels: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        };
        
        await createChartSafely(canvasId, chartName, chartConfig);
        console.log(`[${chartName}]  Chart loaded successfully`);
        
    } catch (error) {
        console.error(`[${chartName}]  Error loading chart:`, error);
        console.error(`[${chartName}] Stack trace:`, error.stack);
    }
}

// Demographics Reports
async function loadDemographicsReports() {
    if (charts.ageDist) return; // Already loaded
    
    await Promise.all([
        loadAgeDistributionChart(),
        loadGenderChart(),
        loadRaceChart(),
        loadGeographicTable(),
        loadHouseholdChart(),
        loadHouseholdScatterChart(),
        loadIncomeChart(),
        loadInsuranceChart(),
        loadCommPrefChart(),
        loadMaritalChart(),
        loadLanguageChart(),
        loadMilitaryCharts()
    ]);
}

async function loadAgeDistributionChart() {
    const response = await cachedFetch('/api/reports/demographics/age-distribution' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
    const data = await response.json();

    const ctx = document.getElementById('ageDistChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.ageDist) charts.ageDist.destroy();    charts.ageDist = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Clients',
                data: data.values,
                backgroundColor: colorSchemes.primary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#333',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value.toLocaleString()
                }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

async function loadGenderChart() {
    const response = await cachedFetch('/api/reports/demographics/gender' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
    const data = await response.json();

    const ctx = document.getElementById('genderChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.gender) charts.gender.destroy();    charts.gender = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: colorSchemes.diverse
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'right' },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 13 },
                    formatter: (value, ctx) => {
                        const arr = ctx.chart.data.datasets[0].data || [];
                        const sum = arr.reduce((a, b) => a + b, 0) || 0;
                        if (!value || sum === 0) return '';
                        const percentage = ((value / sum) * 100).toFixed(1) + '%';
                        return [percentage, `n=${Number(value).toLocaleString()}`];
                    }
                }
            }
        }
    });
}

async function loadRaceChart() {
    const response = await cachedFetch('/api/reports/demographics/race-ethnicity' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
    const data = await response.json();

    const ctx = document.getElementById('raceChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.race) charts.race.destroy();    charts.race = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Clients',
                data: data.values,
                backgroundColor: colorSchemes.warm
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { 
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#333',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value.toLocaleString()
                }
            },
            scales: { x: { beginAtZero: true } }
        }
    });
}

async function loadGeographicTable() {
    const response = await cachedFetch('/api/reports/geographic/cases-by-location' + buildFilterQueryString(), {}, 120000); // Cache for 2 minutes (session-based)
    const data = await response.json();
    
    const tbody = document.querySelector('#geoTable tbody');
    if (data.locations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.locations.map(loc => `
        <tr>
            <td>${escapeHtml(loc.city)}</td>
            <td>${escapeHtml(loc.county)}</td>
            <td>${loc.state}</td>
            <td class="text-end">${loc.case_count}</td>
        </tr>
    `).join('');
}

async function loadHouseholdChart() {
    const chartName = 'Household Size Distribution';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/household-composition' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            displayNoDataMessage('householdChart', 'No data available');
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('householdChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'householdChart' not found`);
            return;
        }
        
        if (charts.household) charts.household.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            displayNoDataMessage('householdChart', 'No household data available');
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        
        charts.household = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Households',
                    data: data.values,
                    backgroundColor: colorSchemes.cool
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    title: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value.toLocaleString()
                    }
                },
                scales: { x: { beginAtZero: true } }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
        displayNoDataMessage('householdChart', 'Error loading data');
    }
}

async function loadHouseholdScatterChart() {
    const chartName = 'Household Adults vs Children';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/household-adults-children' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            displayNoDataMessage('householdScatterChart', 'No data available');
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('householdScatterChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'householdScatterChart' not found`);
            return;
        }
        
        if (charts.householdScatter) charts.householdScatter.destroy();
        
        // Handle empty data
        if (!data.data || data.data.length === 0) {
            console.warn(`[${chartName}] No data available`);
            displayNoDataMessage('householdScatterChart', 'No household composition data available');
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.data.length} data points`);
        
        charts.householdScatter = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'Households',
                    data: data.data.map(d => ({
                        x: d.x,
                        y: d.y,
                        r: Math.sqrt(d.count) * 3  // Scale radius by square root for better visual proportion
                    })),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataPoint = data.data[context.dataIndex];
                                return `Adults: ${dataPoint.x}, Children: ${dataPoint.y} (${dataPoint.count} households)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Adults in Household' },
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    },
                    y: {
                        title: { display: true, text: 'Children in Household' },
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
        displayNoDataMessage('householdScatterChart', 'Error loading data');
    }
}

async function loadIncomeChart() {
    const chartName = 'Income Distribution';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/income-distribution' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('incomeChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'incomeChart' not found`);
            return;
        }
        
        if (charts.income) charts.income.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        charts.income = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Clients',
                    data: data.values,
                    backgroundColor: colorSchemes.primary
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value.toLocaleString()
                    }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
    }
}

async function loadInsuranceChart() {
    const chartName = 'Insurance Coverage';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/insurance-coverage' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('insuranceChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'insuranceChart' not found`);
            return;
        }
        
        if (charts.insurance) charts.insurance.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        charts.insurance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: colorSchemes.warm
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'right' },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 13 },
                        formatter: (value, ctx) => {
                            const arr = ctx.chart.data.datasets[0].data || [];
                            const sum = arr.reduce((a, b) => a + b, 0) || 0;
                            if (!value || sum === 0) return '';
                            const percentage = ((value / sum) * 100).toFixed(1) + '%';
                            return [percentage, `n=${Number(value).toLocaleString()}`];
                        }
                    }
                }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
    }
}

async function loadCommPrefChart() {
    const chartName = 'Communication Preferences';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/communication-preferences' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('commPrefChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'commPrefChart' not found`);
            return;
        }
        
        if (charts.commPref) charts.commPref.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        charts.commPref = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Clients',
                    data: data.values,
                    backgroundColor: colorSchemes.accent
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value.toLocaleString()
                    }
                },
                scales: { x: { beginAtZero: true } }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
    }
}

async function loadMaritalChart() {
    const chartName = 'Marital Status';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/marital-status' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('maritalChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'maritalChart' not found`);
            return;
        }
        
        if (charts.marital) charts.marital.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        charts.marital = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: colorSchemes.cool
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'right' },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 13 },
                        formatter: (value, ctx) => {
                            const arr = ctx.chart.data.datasets[0].data || [];
                            const sum = arr.reduce((a, b) => a + b, 0) || 0;
                            if (!value || sum === 0) return '';
                            const percentage = ((value / sum) * 100).toFixed(1) + '%';
                            return [percentage, `n=${Number(value).toLocaleString()}`];
                        }
                    }
                }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
    }
}

async function loadLanguageChart() {
    const chartName = 'Language Preferences';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/language-preferences' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('languageChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'languageChart' not found`);
            return;
        }
        
        if (charts.language) charts.language.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        charts.language = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Clients',
                    data: data.values,
                    backgroundColor: colorSchemes.primary
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value.toLocaleString()
                    }
                },
                scales: { x: { beginAtZero: true } }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
    }
}

async function loadMilitaryCharts() {
    const response = await cachedFetch('/api/reports/military/veteran-services' + buildFilterQueryString());
    const data = await response.json();
    
    // Military Affiliation Chart
    const affCtx = document.getElementById('milAffChart');
    if (charts.milAff) charts.milAff.destroy();
    
    if (data.by_affiliation.labels.length > 0) {
        charts.milAff = new Chart(affCtx, {
            type: 'bar',
            data: {
                labels: data.by_affiliation.labels,
                datasets: [{
                    label: 'Requests',
                    data: data.by_affiliation.values,
                    backgroundColor: colorSchemes.success[2]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value.toLocaleString()
                    }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
    
    // Military Branch Chart
    const branchCtx = document.getElementById('milBranchChart');
    if (charts.milBranch) charts.milBranch.destroy();
    
    if (data.by_branch.labels.length > 0) {
        charts.milBranch = new Chart(branchCtx, {
            type: 'doughnut',
            data: {
                labels: data.by_branch.labels,
                datasets: [{
                    data: data.by_branch.values,
                    backgroundColor: colorSchemes.diverse
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'right' },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 13 },
                        formatter: (value, ctx) => {
                            const arr = ctx.chart.data.datasets[0].data || [];
                            const sum = arr.reduce((a, b) => a + b, 0) || 0;
                            if (!value || sum === 0) return '';
                            const percentage = ((value / sum) * 100).toFixed(1) + '%';
                            return [percentage, `n=${Number(value).toLocaleString()}`];
                        }
                    }
                }
            }
        });
    }
}

// Services Reports
async function loadServicesReports() {
    if (document.querySelector('#resolutionTimeTable tbody tr td').textContent !== 'Loading...') return;
    
    await Promise.all([
        loadResolutionTimeTable(),
        loadConversionTable(),
        loadSubtypesTable(),
        loadOutcomesTable()
    ]);
}

async function loadResolutionTimeTable() {
    const response = await cachedFetch('/api/reports/service-metrics/resolution-time' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#resolutionTimeTable tbody');
    if (data.metrics.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.metrics.map(m => `
        <tr>
            <td>${escapeHtml(m.service_type)}</td>
            <td class="text-end">${m.total_cases}</td>
            <td class="text-end">${m.avg_days}</td>
            <td class="text-end">${m.min_days}</td>
            <td class="text-end">${m.max_days}</td>
        </tr>
    `).join('');
}

async function loadConversionTable() {
    const response = await cachedFetch('/api/reports/service-metrics/referral-conversion' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#conversionTable tbody');
    if (data.metrics.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.metrics.map(m => `
        <tr>
            <td>${escapeHtml(m.service_type)}</td>
            <td class="text-end">${m.total_referrals}</td>
            <td class="text-end">${m.accepted}</td>
            <td class="text-end">${m.declined}</td>
            <td class="text-end">${m.pending}</td>
            <td class="text-end"><strong>${m.acceptance_rate}%</strong></td>
        </tr>
    `).join('');
}

async function loadSubtypesTable() {
    const response = await cachedFetch('/api/reports/service-subtypes' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#subtypesTable tbody');
    if (data.subtypes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.subtypes.map(s => `
        <tr>
            <td>${escapeHtml(s.service_type)}</td>
            <td>${escapeHtml(s.service_subtype)}</td>
            <td class="text-end">${s.count}</td>
        </tr>
    `).join('');
}

async function loadOutcomesTable() {
    const response = await cachedFetch('/api/reports/case-outcomes' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#outcomesTable tbody');
    if (data.outcomes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    const total = data.outcomes.reduce((sum, o) => sum + o.count, 0);
    tbody.innerHTML = data.outcomes.map(o => `
        <tr>
            <td>${escapeHtml(o.resolution_type || 'Unspecified')}</td>
            <td class="text-end">${o.count}</td>
            <td class="text-end">${((o.count / total) * 100).toFixed(1)}%</td>
        </tr>
    `).join('');
}

// Network Reports
async function loadNetworkReports() {
    if (charts.sendingProviders) return;
    
    await Promise.all([
        loadProviderCharts(),
        loadCollaborationTable(),
        loadReferralFlowSankey(),
        loadTopProgramsTable()
        // Note: loadProviderLeaderboard() and loadServicePathways() moved to loadOutcomesReports()
        // to avoid duplicate loading since they're displayed in the Outcomes tab
    ]);
}

async function loadProviderCharts() {
    // Sending providers
    const sendingResponse = await cachedFetch('/api/reports/sending-providers' + buildFilterQueryString());
    const sendingData = await sendingResponse.json();
    
    const sendingCtx = document.getElementById('sendingProvidersChart');
    if (charts.sendingProviders) charts.sendingProviders.destroy();
    
    charts.sendingProviders = new Chart(sendingCtx, {
        type: 'bar',
        data: {
            labels: sendingData.labels,
            datasets: [{
                label: 'Referrals Sent',
                data: sendingData.values,
                backgroundColor: colorSchemes.primary[1]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    
    // Receiving providers
    const receivingResponse = await cachedFetch('/api/reports/receiving-providers' + buildFilterQueryString());
    const receivingData = await receivingResponse.json();
    
    const receivingCtx = document.getElementById('receivingProvidersChart');
    if (charts.receivingProviders) charts.receivingProviders.destroy();
    
    charts.receivingProviders = new Chart(receivingCtx, {
        type: 'bar',
        data: {
            labels: receivingData.labels,
            datasets: [{
                label: 'Referrals Received',
                data: receivingData.values,
                backgroundColor: colorSchemes.success[3]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

async function loadCollaborationTable() {
    const response = await cachedFetch('/api/reports/network/provider-collaboration' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#collaborationTable tbody');
    if (data.collaborations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.collaborations.map(c => `
        <tr>
            <td>${escapeHtml(c.from)}</td>
            <td class="text-center"><i class="fas fa-arrow-right text-muted"></i></td>
            <td>${escapeHtml(c.to)}</td>
            <td class="text-end"><strong>${c.count}</strong></td>
        </tr>
    `).join('');
}

async function loadReferralFlowSankey() {
    try {
        const minReferrals = document.getElementById('sankeyMinReferrals')?.value || 5;
        const filterString = buildFilterQueryString();
        const separator = filterString ? '&' : '?';
        const response = await fetch(`/api/reports/referral-flow-sankey${filterString}${filterString ? '&' : '?'}min_referrals=${minReferrals}`);
        const data = await response.json();
        
        const container = document.getElementById('referralFlowSankey');
        
        if (!data.nodes || data.nodes.length === 0) {
            container.innerHTML = '<div class="text-center text-muted p-5">No referral flow data available for the selected filters</div>';
            return;
        }
        
        // Create Sankey diagram
        const trace = {
            type: "sankey",
            orientation: "h",
            node: {
                pad: 15,
                thickness: 20,
                line: {
                    color: "black",
                    width: 0.5
                },
                label: data.nodes.map(n => n.name),
                color: data.nodes.map((n, i) => {
                    // Color nodes based on position for better visualization
                    const colors = ['#2c5282', '#38a169', '#dd6b20', '#805ad5', '#d53f8c', '#319795'];
                    return colors[i % colors.length];
                })
            },
            link: {
                source: data.links.map(l => l.source),
                target: data.links.map(l => l.target),
                value: data.links.map(l => l.value),
                label: data.links.map(l => l.label),
                color: data.links.map(() => 'rgba(200, 200, 200, 0.4)')
            }
        };
        
        const layout = {
            title: {
                text: "Patient Movement Between Providers",
                font: { size: 14 }
            },
            font: {
                size: 11
            },
            height: 600,
            margin: {
                l: 10,
                r: 10,
                t: 40,
                b: 10
            },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)'
        };
        
        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
            toImageButtonOptions: {
                format: 'png',
                filename: 'referral_flow_sankey',
                height: 800,
                width: 1200,
                scale: 2
            }
        };
        
        Plotly.newPlot(container, [trace], layout, config);
    } catch (error) {
        console.error('Error loading Sankey diagram:', error);
        document.getElementById('referralFlowSankey').innerHTML = 
            '<div class="text-center text-danger p-5">Error loading referral flow data</div>';
    }
}

async function loadTopProgramsTable() {
    const response = await cachedFetch('/api/reports/top-programs' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#topProgramsTable tbody');
    if (data.programs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.programs.map(p => `
        <tr>
            <td>${escapeHtml(p.program_name)}</td>
            <td class="text-end">${p.total_referrals}</td>
            <td class="text-end">${p.accepted_referrals}</td>
            <td class="text-end"><strong>${p.acceptance_rate}%</strong></td>
        </tr>
    `).join('');
}

async function loadProviderLeaderboard() {
    const tbody = document.getElementById('providerLeaderboardBody');
    
    try {
        console.log('[loadProviderLeaderboard] Starting...');
        
        // Show loading state
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading leaderboard...</td></tr>';
        
        const response = await cachedFetch('/api/reports/provider-performance' + buildFilterQueryString());
        console.log('[loadProviderLeaderboard] Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('[loadProviderLeaderboard] Data received:', data);
        
        // Handle API errors
        if (data.error) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${escapeHtml(data.error)}</td></tr>`;
            return;
        }
        
        // Handle empty or missing data
        if (!data.providers || !Array.isArray(data.providers) || data.providers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No provider data available. Run an ETL job to populate data.</td></tr>';
            return;
        }
        
        // Filter providers with at least 5 cases and sort
        const providers = data.providers
            .filter(p => p && typeof p.total_cases === 'number' && p.total_cases >= 5)
            .sort((a, b) => {
                if (b.total_cases !== a.total_cases) return b.total_cases - a.total_cases;
                // Handle null/undefined avg_days gracefully
                const aAvg = typeof a.avg_days === 'number' ? a.avg_days : Infinity;
                const bAvg = typeof b.avg_days === 'number' ? b.avg_days : Infinity;
                return aAvg - bAvg;
            });
        
        if (providers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No providers with 5+ cases found. Lower the threshold or add more data.</td></tr>';
            return;
        }
        
        tbody.innerHTML = providers.map((p, index) => {
            const rankClass = index === 0 ? 'text-warning fw-bold' : index === 1 ? 'text-secondary' : index === 2 ? 'text-bronze' : '';
            const rankIcon = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : '';
            
            // Safely handle potentially missing or null values
            const providerName = p.provider_name || 'Unknown Provider';
            const totalCases = p.total_cases || 0;
            const pendingCases = p.pending_cases || 0;
            const avgDays = (typeof p.avg_days === 'number' && p.avg_days !== null) ? p.avg_days.toFixed(1) : 'N/A';
            const minDays = (typeof p.min_days === 'number' && p.min_days !== null) ? p.min_days.toFixed(1) : 'N/A';
            const maxDays = (typeof p.max_days === 'number' && p.max_days !== null) ? p.max_days.toFixed(1) : 'N/A';
            const completionRate = (typeof p.completion_rate === 'number') ? p.completion_rate.toFixed(1) : '0.0';
            
            return `
            <tr class="text-dark">
                <td class="text-center ${rankClass}">
                    <span style="font-size: 1.1em;">${rankIcon || (index + 1)}</span>
                </td>
                <td><strong>${escapeHtml(providerName)}</strong></td>
                <td class="text-end">${totalCases}</td>
                <td class="text-end">${pendingCases}</td>
                <td class="text-end">${avgDays}</td>
                <td class="text-end text-success">${minDays}</td>
                <td class="text-end text-danger">${maxDays}</td>
                <td class="text-end"><strong>${completionRate}%</strong></td>
            </tr>
            `;
        }).join('');
        
        console.log('[loadProviderLeaderboard] Complete! Rendered', providers.length, 'providers');
        
    } catch (error) {
        console.error('[loadProviderLeaderboard] Error:', error);
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4"><i class="fas fa-exclamation-circle me-2"></i>Error loading leaderboard: ${escapeHtml(error.message)}</td></tr>`;
    }
}

async function loadServicePathways() {
    const tbody = document.querySelector('#pathwaysTable tbody');
    
    try {
        console.log('[loadServicePathways] Starting...');
        
        // Show loading state
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading pathways...</td></tr>';
        
        const response = await cachedFetch('/api/reports/service-pathways' + buildFilterQueryString());
        console.log('[loadServicePathways] Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('[loadServicePathways] Data received:', data);
        
        // Handle API errors
        if (data.error) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${escapeHtml(data.error)}</td></tr>`;
            return;
        }
        
        // Handle empty or missing data
        if (!data.pathways || !Array.isArray(data.pathways) || data.pathways.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>No service pathways found. Data requires multiple services per case.</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.pathways.map(p => {
            // Safely handle potentially missing values
            const initialService = p.initial_service || 'Unknown';
            const referralService = p.referral_service || 'Unknown';
            const count = p.count || 0;
            const avgDays = (typeof p.avg_days_between === 'number' && p.avg_days_between !== null) 
                ? p.avg_days_between.toFixed(1) 
                : 'N/A';
            
            return `
            <tr>
                <td>${escapeHtml(initialService)}</td>
                <td class="text-center"><i class="fas fa-arrow-right text-primary"></i></td>
                <td>${escapeHtml(referralService)}</td>
                <td class="text-end"><strong>${count}</strong></td>
                <td class="text-end">${avgDays}</td>
            </tr>
            `;
        }).join('');
        
        console.log('[loadServicePathways] Complete! Rendered', data.pathways.length, 'pathways');
        
    } catch (error) {
        console.error('[loadServicePathways] Error:', error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error loading pathways: ${escapeHtml(error.message)}</td></tr>`;
    }
}

// Performance Reports
async function loadPerformanceReports() {
    if (document.querySelector('#workloadTable tbody tr td').textContent !== 'Loading...') return;
    
    await Promise.all([
        loadWorkloadTable(),
        loadClientJourneyMetrics(),
        loadCasesOverTimeChart()
    ]);
}

async function loadWorkloadTable() {
    const response = await cachedFetch('/api/reports/workforce/employee-workload' + buildFilterQueryString());
    const data = await response.json();
    
    const tbody = document.querySelector('#workloadTable tbody');
    if (data.employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.employees.map(e => `
        <tr>
            <td>${escapeHtml(e.employee_name)}</td>
            <td>${escapeHtml(e.provider)}</td>
            <td class="text-end">${e.active_cases}</td>
            <td class="text-end">${e.total_cases}</td>
            <td class="text-end">${e.resolved_cases}</td>
            <td class="text-end"><strong>${e.resolution_rate}%</strong></td>
        </tr>
    `).join('');
}

async function loadClientJourneyMetrics() {
    const response = await cachedFetch('/api/reports/client-journey' + buildFilterQueryString());
    const data = await response.json();
    
    document.getElementById('journeyTotalClients').textContent = data.summary.total_clients.toLocaleString();
    document.getElementById('journeyAvgCases').textContent = data.summary.avg_cases_per_client;
    document.getElementById('journeyAvgReferrals').textContent = data.summary.avg_referrals_per_client;
    document.getElementById('journeyAvgAR').textContent = data.summary.avg_assistance_requests_per_client;
    
    // Touchpoint distribution chart
    const ctx = document.getElementById('touchpointChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.touchpoint) charts.touchpoint.destroy();
    
    charts.touchpoint = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.touchpoint_distribution.labels,
            datasets: [{
                label: 'Clients',
                data: data.touchpoint_distribution.values,
                backgroundColor: colorSchemes.primary[2]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                title: { display: true, text: 'Number of Service Touchpoints per Client' }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

async function loadCasesOverTimeChart() {
    const grouping = document.getElementById('casesTimeGrouping').value;
    const filterString = buildFilterQueryString();
    const separator = filterString ? '&' : '?';
    const response = await fetch(`/api/reports/trends/cases-over-time?grouping=${grouping}${filterString ? separator + filterString.substring(1) : ''}`);
    const data = await response.json();
    
    const ctx = document.getElementById('casesOverTimeChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.casesOverTime) charts.casesOverTime.destroy();
    
    // Assign colors to each status
    const statusColors = {
        'managed': colorSchemes.success[3],
        'active': colorSchemes.primary[2],
        'processed': colorSchemes.warm[3],
        'closed': colorSchemes.diverse[5],
        'off_platform': colorSchemes.diverse[6]
    };
    
    const datasets = data.datasets.map(ds => ({
        label: ds.label,
        data: ds.data,
        backgroundColor: statusColors[ds.label] || colorSchemes.diverse[0],
        borderColor: statusColors[ds.label] || colorSchemes.diverse[0],
        borderWidth: 2,
        fill: false,
        tension: 0.3
    }));
    
    charts.casesOverTime = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'top' }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    stacked: false
                }
            }
        }
    });
}

// Outcomes Reports
async function loadOutcomesReports() {
    if (charts.referralFunnel) return; // Already loaded
    
    try {
        await Promise.all([
            loadReferralFunnelAnalysis().catch(e => console.error('Funnel error:', e)),
            loadTimingAnalysis().catch(e => console.error('Timing error:', e)),
            loadProviderPerformanceMetrics().catch(e => console.error('Provider error:', e)),
            loadHighRiskDropOffAnalysis().catch(e => console.error('Risk error:', e)),
            loadClientJourneyStages().catch(e => console.error('Journey error:', e)),
            loadOutcomeMetrics().catch(e => console.error('Outcome metrics error:', e)),
            loadProviderLeaderboard().catch(e => console.error('Provider leaderboard error:', e)),
            loadServicePathways().catch(e => console.error('Service pathways error:', e))
        ]);
    } catch (error) {
        console.error('Error loading outcomes reports:', error);
    }
}

async function loadReferralFunnelAnalysis() {
    try {
        const filterQuery = buildFilterQueryString();
        const response = await fetch(`/api/reports/referral-funnel-analysis${filterQuery}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.stages || data.stages.length === 0) {
            console.warn('No referral funnel data available');
            // Update with zero values
            document.getElementById('completionRate').textContent = '0';
            document.getElementById('acceptanceRate').textContent = '0';
            return;
        }
    
    // Update completion and acceptance rates
    document.getElementById('completionRate').textContent = data.overall_completion_rate || 0;
    document.getElementById('acceptanceRate').textContent = data.acceptance_rate || 0;
    
    // Funnel Chart
    const ctx = document.getElementById('referralFunnelChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.referralFunnel) charts.referralFunnel.destroy();
    
    charts.referralFunnel = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.stages.map(s => s.stage),
            datasets: [{
                label: 'Count',
                data: data.stages.map(s => s.count),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const stage = data.stages[context.dataIndex];
                            return [
                                `Count: ${stage.count.toLocaleString()}`,
                                `Percentage: ${stage.percentage}%`,
                                `Dropped: ${stage.drop_from_previous.toLocaleString()}`
                            ];
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                } 
            }
        }
    });
    
    // Drop-off Reasons Pie Chart
    const dropCtx = document.getElementById('dropOffReasonsChart');
    if (charts.dropOffReasons) charts.dropOffReasons.destroy();
    
    if (data.drop_off_reasons && data.drop_off_reasons.length > 0) {
        charts.dropOffReasons = new Chart(dropCtx, {
            type: 'doughnut',
            data: {
                labels: data.drop_off_reasons.map(r => r.reason),
                datasets: [{
                    data: data.drop_off_reasons.map(r => r.count),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { 
                            font: { size: 11 },
                            padding: 8
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const reason = data.drop_off_reasons[context.dataIndex];
                                return [
                                    reason.reason,
                                    `Count: ${reason.count.toLocaleString()}`,
                                    `${reason.percentage}% of total`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }
    } catch (error) {
        console.error('Error in referral funnel analysis:', error);
        document.getElementById('completionRate').textContent = '0';
        document.getElementById('acceptanceRate').textContent = '0';
    }
}

async function loadTimingAnalysis() {
    try {
        const filterQuery = buildFilterQueryString();
        const response = await fetch(`/api/reports/referral-timing-analysis${filterQuery}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.timing_stages || data.timing_stages.length === 0) {
            console.warn('No timing analysis data available');
            return;
        }
    
    // Timing Chart
    const ctx = document.getElementById('timingAnalysisChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.timingAnalysis) charts.timingAnalysis.destroy();
    
    charts.timingAnalysis = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.timing_stages.map(s => s.stage),
            datasets: [
                {
                    label: 'Min Days',
                    data: data.timing_stages.map(s => s.min_days),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Avg Days',
                    data: data.timing_stages.map(s => s.avg_days),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Max Days',
                    data: data.timing_stages.map(s => s.max_days),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: { font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} days`;
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    title: { display: true, text: 'Days' }
                } 
            }
        }
    });
    
    // Timing Stats Cards
    const statsDiv = document.getElementById('timingStats');
    statsDiv.innerHTML = data.timing_stages.map(stage => `
        <div class="col-md-${12 / data.timing_stages.length}">
            <div class="border rounded p-2">
                <small class="text-muted d-block">${stage.stage}</small>
                <div class="d-flex justify-content-between mt-1">
                    <span class="badge bg-success">${stage.min_days} days</span>
                    <span class="badge bg-primary">${stage.avg_days} days</span>
                    <span class="badge bg-danger">${stage.max_days} days</span>
                </div>
                <small class="text-muted">${stage.count.toLocaleString()} referrals</small>
            </div>
        </div>
    `).join('');
    } catch (error) {
        console.error('Error in timing analysis:', error);
    }
}

async function loadProviderPerformanceMetrics() {
    try {
        const providerType = document.querySelector('input[name="providerType"]:checked')?.value || 'receiving';
        const filterQuery = buildFilterQueryString();
        
        // Build URL with proper query string separator
        const separator = filterQuery ? '&' : '?';
        const response = await fetch(`/api/reports/provider-performance-metrics${filterQuery}${separator}provider_type=${providerType}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
    
    const tbody = document.getElementById('providerMetricsBody');
    if (!data.providers || data.providers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.providers.map(p => {
        const acceptClass = p.acceptance_rate >= 80 ? 'text-success' : p.acceptance_rate >= 60 ? 'text-warning' : 'text-danger';
        const completeClass = p.completion_rate >= 70 ? 'text-success' : p.completion_rate >= 50 ? 'text-warning' : 'text-danger';
        
        return `
            <tr>
                <td class="small">${escapeHtml(p.provider_name)}</td>
                <td class="text-end">
                    <span class="badge bg-secondary">${p.total_referrals}</span>
                </td>
                <td class="text-end">
                    <span class="badge ${acceptClass === 'text-success' ? 'bg-success' : acceptClass === 'text-warning' ? 'bg-warning' : 'bg-danger'}">
                        ${p.acceptance_rate}%
                    </span>
                </td>
                <td class="text-end">
                    <span class="badge ${completeClass === 'text-success' ? 'bg-success' : completeClass === 'text-warning' ? 'bg-warning' : 'bg-danger'}">
                        ${p.completion_rate}%
                    </span>
                </td>
                <td class="text-end small">${p.avg_response_days} days</td>
            </tr>
        `;
    }).join('');
    } catch (error) {
        console.error('Error in provider performance metrics:', error);
        const tbody = document.getElementById('providerMetricsBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Error loading data</td></tr>';
    }
}

async function loadHighRiskDropOffAnalysis() {
    try {
        const filterQuery = buildFilterQueryString();
        const response = await fetch(`/api/reports/high-risk-drop-off-analysis${filterQuery}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
    
    const tbody = document.getElementById('highRiskBody');
    if (!data.service_types || data.service_types.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.service_types.map(st => {
        const riskClass = st.drop_off_rate >= 40 ? 'danger' : st.drop_off_rate >= 25 ? 'warning' : 'success';
        
        return `
            <tr>
                <td class="small">${escapeHtml(st.service_type)}</td>
                <td class="text-end">
                    <small class="text-muted">${st.total_referrals}</small>
                </td>
                <td class="text-end">
                    <span class="badge bg-${riskClass}">${st.drop_off_rate}%</span>
                </td>
            </tr>
        `;
    }).join('');
    } catch (error) {
        console.error('Error in high-risk drop-off analysis:', error);
        const tbody = document.getElementById('highRiskBody');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Error loading data</td></tr>';
    }
}

async function loadClientJourneyStages() {
    try {
        const filterQuery = buildFilterQueryString();
        const response = await fetch(`/api/reports/client-journey-stages${filterQuery}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.stages || data.stages.length === 0) {
            console.warn('No journey stages data available');
            return;
        }
    
    const ctx = document.getElementById('journeyStagesChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.journeyStages) charts.journeyStages.destroy();
    
    charts.journeyStages = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.stages.map(s => s.status),
            datasets: [{
                label: 'Referral Count',
                data: data.stages.map(s => s.count),
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const stage = data.stages[context.dataIndex];
                            return [
                                `Count: ${stage.count.toLocaleString()}`,
                                `Unique Clients: ${stage.unique_clients.toLocaleString()}`,
                                `Avg Days: ${stage.avg_days_in_stage.toFixed(1)}`
                            ];
                        }
                    }
                }
            },
            scales: { 
                x: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('Error in client journey stages:', error);
    }
}

async function loadServiceFunnel() {
    const filterQuery = buildFilterQueryString();
    const response = await fetch(`/api/reports/service-funnel${filterQuery}`);
    const data = await response.json();
    
    if (data.error) {
        console.error('Error loading service funnel:', data.error);
        return;
    }
    
    const ctx = document.getElementById('funnelChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.funnel) charts.funnel.destroy();
    
    charts.funnel = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.stages.map(s => s.name),
            datasets: [{
                label: 'Count',
                data: data.stages.map(s => s.count),
                backgroundColor: colorSchemes.primary,
                borderColor: colorSchemes.primary[0],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const stage = data.stages[context.dataIndex];
                            return [
                                `Count: ${stage.count.toLocaleString()}`,
                                `Percentage: ${stage.percentage}%`
                            ];
                        }
                    }
                }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

async function loadOutcomeMetrics() {
    const filterQuery = buildFilterQueryString();
    
    try {
        console.log('[Outcome Metrics] Fetching data...');
        const response = await fetch(`/api/reports/outcome-metrics${filterQuery}`);
        console.log('[Outcome Metrics] Response status:', response.status);
        
        if (!response.ok) {
            console.error('[Outcome Metrics] HTTP Error:', response.status);
            displayNoDataMessage('resolutionTypesChart', 'Error loading data');
            displayNoDataMessage('resolutionByServiceChart', 'Error loading data');
            return;
        }
        
        const data = await response.json();
        console.log('[Outcome Metrics] Data received:', data);
        
        if (data.error) {
            console.error('[Outcome Metrics] API Error:', data.error);
            displayNoDataMessage('resolutionTypesChart', 'Error loading data');
            displayNoDataMessage('resolutionByServiceChart', 'Error loading data');
            return;
        }
        
        // Resolution Types Chart
        const resCtx = document.getElementById('resolutionTypesChart');
        if (!resCtx) {
            console.error('[Resolution Types] Canvas element not found');
            return;
        }
        
        if (charts.resolutionTypes) charts.resolutionTypes.destroy();
        
        if (data.outcome_distribution && data.outcome_distribution.types && data.outcome_distribution.types.length > 0) {
            console.log(`[Resolution Types] Creating chart with ${data.outcome_distribution.types.length} items`);
            charts.resolutionTypes = new Chart(resCtx, {
                type: 'doughnut',
                data: {
                    labels: data.outcome_distribution.types,
                    datasets: [{
                        data: data.outcome_distribution.counts,
                        backgroundColor: colorSchemes.diverse
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
            console.log('[Resolution Types] Chart created successfully');
        } else {
            console.warn('[Resolution Types] No data available');
            displayNoDataMessage('resolutionTypesChart', 'No resolution data available');
        }
        
        // Resolution by Service Chart
        const servCtx = document.getElementById('resolutionByServiceChart');
        if (!servCtx) {
            console.error('[Avg Resolution Time] Canvas element not found');
            return;
        }
        
        if (charts.resolutionByService) charts.resolutionByService.destroy();
        
        if (data.resolution_times && data.resolution_times.length > 0) {
            console.log(`[Avg Resolution Time] Creating chart with ${data.resolution_times.length} items`);
            charts.resolutionByService = new Chart(servCtx, {
                type: 'bar',
                data: {
                    labels: data.resolution_times.map(r => r.service_type),
                    datasets: [{
                        label: 'Avg Days',
                        data: data.resolution_times.map(r => r.avg_days),
                        backgroundColor: colorSchemes.warm[2]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
            console.log('[Avg Resolution Time] Chart created successfully');
        } else {
            console.warn('[Avg Resolution Time] No data available');
            displayNoDataMessage('resolutionByServiceChart', 'No resolution time data available');
        }
    } catch (error) {
        console.error('[Outcome Metrics] Error:', error);
        displayNoDataMessage('resolutionTypesChart', 'Error loading data');
        displayNoDataMessage('resolutionByServiceChart', 'Error loading data');
    }
}

// DUPLICATE FUNCTIONS REMOVED - Using versions at lines 2759 and 2843 which have proper error handling and logging

// Geographic Reports
async function loadGeographicReports() {
    if (charts.cities) return; // Already loaded
    
    await Promise.all([
        loadGeographicDistribution()
    ]);
}

async function loadGeographicDistribution() {
    const filterQuery = buildFilterQueryString();
    const response = await fetch(`/api/reports/geographic-distribution${filterQuery}`);
    const data = await response.json();
    
    if (data.error) {
        console.error('Error loading geographic distribution:', data.error);
        return;
    }
    
    // Cities Chart
    if (data.by_city && data.by_city.length > 0) {
        const citiesCtx = document.getElementById('citiesChart');
        if (charts.cities) charts.cities.destroy();
        
        charts.cities = new Chart(citiesCtx, {
            type: 'bar',
            data: {
                labels: data.by_city.map(c => c.city),
                datasets: [{
                    label: 'Cases',
                    data: data.by_city.map(c => c.cases),
                    backgroundColor: colorSchemes.primary[1]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    }
    
    // Counties Chart
    if (data.by_county && data.by_county.length > 0) {
        const countiesCtx = document.getElementById('countiesChart');
        if (charts.counties) charts.counties.destroy();
        
        charts.counties = new Chart(countiesCtx, {
            type: 'pie',
            data: {
                labels: data.by_county.map(c => c.county),
                datasets: [{
                    data: data.by_county.map(c => c.cases),
                    backgroundColor: colorSchemes.diverse
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });
    }
    
    // ZIP Table
    const tbody = document.querySelector('#zipTable tbody');
    if (data.by_zip && data.by_zip.length > 0) {
        tbody.innerHTML = data.by_zip.map(z => `
            <tr>
                <td>${escapeHtml(z.zip)}</td>
                <td class="text-end">${z.cases}</td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No data available</td></tr>';
    }
}

// Advanced Reports
async function loadAdvancedReports() {
    if (charts.cohort) return; // Already loaded
    
    await Promise.all([
        loadCohortAnalysis(),
        loadReferralNetwork(),
        loadClientRiskFactors(),
        loadReferralsTimeSeries(),
        loadHouseholdSizeChart()
    ]);
}

async function loadHouseholdSizeChart() {
    const chartName = 'Household Size Distribution';
    try {
        console.log(`[${chartName}] Fetching data...`);
        const response = await cachedFetch('/api/reports/demographics/household-composition' + buildFilterQueryString());
        console.log(`[${chartName}] Response status: ${response.status}`);
        
        if (!response.ok) {
            console.error(`[${chartName}] HTTP Error: ${response.status} ${response.statusText}`);
            displayNoDataMessage('householdSizeChart', 'Error loading data');
            return;
        }
        
        const data = await response.json();
        console.log(`[${chartName}] Data received:`, data);
        
        const ctx = document.getElementById('householdSizeChart');
        if (!ctx) {
            console.error(`[${chartName}] Canvas element 'householdSizeChart' not found`);
            return;
        }
        
        if (charts.householdSize) charts.householdSize.destroy();
        
        // Handle empty data
        if (!data.labels || data.labels.length === 0) {
            console.warn(`[${chartName}] No data available - labels empty or missing`);
            displayNoDataMessage('householdSizeChart', 'No household data available');
            return;
        }
        
        console.log(`[${chartName}] Creating chart with ${data.labels.length} items`);
        
        charts.householdSize = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Households',
                    data: data.values,
                    backgroundColor: colorSchemes.cool
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    title: { display: false }
                },
                scales: { x: { beginAtZero: true } }
            }
        });
        console.log(`[${chartName}] Chart created successfully`);
    } catch (error) {
        console.error(`[${chartName}] Error:`, error);
        displayNoDataMessage('householdSizeChart', 'Error loading data');
    }
}

async function loadCohortAnalysis() {
    const filterQuery = buildFilterQueryString();
    const response = await fetch(`/api/reports/cohort-analysis${filterQuery}`);
    const data = await response.json();
    
    if (data.error) {
        console.error('Error loading cohort analysis:', data.error);
        return;
    }
    
    const ctx = document.getElementById('cohortChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.cohort) charts.cohort.destroy();
    
    if (data.cohorts && data.cohorts.length > 0) {
        charts.cohort = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.cohorts,
                datasets: [
                    {
                        label: 'Cohort Size',
                        data: data.cohort_sizes,
                        borderColor: colorSchemes.primary[0],
                        backgroundColor: 'rgba(44, 82, 130, 0.1)',
                        fill: false
                    },
                    {
                        label: 'Return Rate %',
                        data: data.return_rates,
                        borderColor: colorSchemes.success[3],
                        backgroundColor: 'rgba(56, 161, 105, 0.1)',
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: { display: true, text: 'Cohort Size' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Return Rate %' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }
}

async function loadReferralNetwork() {
    const filterQuery = buildFilterQueryString();
    const response = await fetch(`/api/reports/referral-network${filterQuery}`);
    const data = await response.json();
    
    if (data.error) {
        console.error('Error loading referral network:', data.error);
        return;
    }
    
    const tbody = document.querySelector('#networkTable tbody');
    if (!data.connections || data.connections.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.connections.map(c => `
        <tr>
            <td>${escapeHtml(c.source)}</td>
            <td class="text-center"><i class="fas fa-arrow-right text-muted"></i></td>
            <td>${escapeHtml(c.target)}</td>
            <td class="text-end"><strong>${c.referrals}</strong></td>
            <td class="text-end">${c.unique_clients}</td>
            <td class="text-end">${c.acceptance_rate}%</td>
        </tr>
    `).join('');
}

async function loadClientRiskFactors() {
    const filterQuery = buildFilterQueryString();
    const response = await fetch(`/api/reports/client-risk-factors${filterQuery}`);
    const data = await response.json();
    
    if (data.error) {
        console.error('Error loading risk factors:', data.error);
        return;
    }
    
    // Housing Chart
    if (data.housing_impact && data.housing_impact.length > 0) {
        const housingCtx = document.getElementById('housingChart');
        if (charts.housing) charts.housing.destroy();
        
        charts.housing = new Chart(housingCtx, {
            type: 'bar',
            data: {
                labels: data.housing_impact.map(h => h.status),
                datasets: [{
                    label: 'Cases',
                    data: data.housing_impact.map(h => h.cases),
                    backgroundColor: colorSchemes.warm[2]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
    
    // Household Chart
    if (data.household_size && data.household_size.length > 0) {
        const householdCtx = document.getElementById('householdChart');
        if (charts.household) charts.household.destroy();
        
        charts.household = new Chart(householdCtx, {
            type: 'bar',
            data: {
                labels: data.household_size.map(h => h.category),
                datasets: [{
                    label: 'Cases',
                    data: data.household_size.map(h => h.cases),
                    backgroundColor: colorSchemes.success[3]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
}

async function loadReferralsTimeSeries() {
    const filterQuery = buildFilterQueryString();
    const response = await fetch(`/api/reports/time-series/referrals${filterQuery}`);
    const data = await response.json();
    
    if (data.error) {
        console.error('Error loading referrals time series:', data.error);
        return;
    }
    
    const ctx = document.getElementById('referralsTimeChart');
    if (!ctx) return; // Canvas not in DOM yet
    if (charts.referralsTime) charts.referralsTime.destroy();
    
    if (data.dates && data.dates.length > 0) {
        charts.referralsTime = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Referrals',
                    data: data.counts,
                    borderColor: colorSchemes.primary[2],
                    backgroundColor: 'rgba(66, 153, 225, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
}

function showInfo(message) {
    showToast(message, 'info');
}

function showSuccess_OLD(message) {
    showToast(message, 'success');
}

function showToast(message, type) {
    const bgClass = type === 'success' ? 'bg-success' : type === 'info' ? 'bg-info' : 'bg-danger';
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${bgClass} border-0 position-fixed top-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    setTimeout(() => toast.remove(), 5000);
}

// Utility functions
function exportChart(chartId, filename) {
    const canvas = document.getElementById(chartId);
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = `${filename}-${new Date().toISOString().split('T')[0]}.png`;
    link.href = url;
    link.click();
}

function exportTableToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    let csv = [];
    
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    csv.push(headers.join(','));
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cols = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent.trim()}"`);
        if (cols.length > 0 && cols[0] !== '"Loading..."') csv.push(cols.join(','));
    });
    
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
    link.href = url;
    link.click();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to display "No data available" message in place of chart
function displayNoDataMessage(canvasId, message) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Set text style
    ctx.fillStyle = '#6c757d';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Draw message
    ctx.fillText(message || 'No data available', width / 2, height / 2);
}

// Helper function to safely format numbers with fallback
function safeNumber(value, decimals = 0, fallback = 'N/A') {
    if (value === null || value === undefined || value === '' || isNaN(value)) {
        return fallback;
    }
    if (typeof value === 'number') {
        return decimals > 0 ? value.toFixed(decimals) : value.toString();
    }
    const num = parseFloat(value);
    return isNaN(num) ? fallback : (decimals > 0 ? num.toFixed(decimals) : num.toString());
}

// Helper function to safely format percentages
function safePercent(value, decimals = 1, fallback = '0.0%') {
    const num = safeNumber(value, decimals, null);
    return num === null ? fallback : `${num}%`;
}

// Helper function to check if data is valid
function hasValidData(data) {
    return data && 
           typeof data === 'object' && 
           !data.error;
}

// Helper function to display loading state in a table
function showTableLoading(tbody, colspan, message = 'Loading...') {
    tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin me-2"></i>${message}</td></tr>`;
}

// Helper function to display empty state in a table
function showTableEmpty(tbody, colspan, message = 'No data available') {
    tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted py-3"><i class="fas fa-info-circle me-2"></i>${message}</td></tr>`;
}

// Helper function to display error state in a table
function showTableError(tbody, colspan, error) {
    const message = typeof error === 'string' ? error : error.message || 'Unknown error';
    tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger py-3"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${escapeHtml(message)}</td></tr>`;
}

function showError(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// ============================================================================
// EXPORT TO WORD MODAL - ACTIVE CODE
// ============================================================================

// Export to Word Modal Functions
function selectAllExportCharts() {
    document.querySelectorAll('.export-chart-checkbox').forEach(cb => cb.checked = true);
    updateExportSelectedCount();
}

function deselectAllExportCharts() {
    document.querySelectorAll('.export-chart-checkbox').forEach(cb => cb.checked = false);
    updateExportSelectedCount();
}

function updateExportSelectedCount() {
    const count = document.querySelectorAll('.export-chart-checkbox:checked').length;
    const badge = document.getElementById('exportSelectedCount');
    if (badge) badge.textContent = count;
}

async function exportSelectedChartsToWord() {
    const selectedCharts = [];
    document.querySelectorAll('.export-chart-checkbox:checked').forEach(cb => {
        const chartId = cb.dataset.chartId;
        // Only include charts that have actually been rendered
        if (window.dashboardCharts && window.dashboardCharts[chartId]) {
            selectedCharts.push({
                id: chartId,
                title: cb.nextElementSibling.textContent,
                canvas: window.dashboardCharts[chartId].canvas
            });
        }
    });
    
    if (selectedCharts.length === 0) {
        showError('Please navigate through the tabs to load charts, then try exporting again');
        return;
    }
    
    const btn = document.getElementById('exportWordBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
    
    try {
        // Capture chart images
        const chartImages = {};
        for (const chart of selectedCharts) {
            try {
                const imageData = chart.canvas.toDataURL('image/png');
                chartImages[chart.id] = imageData;
            } catch (error) {
                console.error(`Error capturing chart ${chart.id}:`, error);
            }
        }
        
        // Get current date range from filter inputs if available
        const startDate = document.getElementById('filterStartDate')?.value || '';
        const endDate = document.getElementById('filterEndDate')?.value || '';
        const period = startDate && endDate ? `${startDate} to ${endDate}` : 'All Time';
        
        const reportData = {
            period: period,
            generated_date: new Date().toLocaleString(),
            summary: {},
            charts: chartImages
        };
        
        console.log('Exporting report with data:', {
            period: reportData.period,
            chartCount: Object.keys(chartImages).length,
            chartIds: Object.keys(chartImages)
        });
        
        const response = await cachedFetch('/api/reports/export/annual-report-word', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reportData)
        });
        
        console.log('Export response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Export failed:', errorText);
            throw new Error(`Export failed: ${response.status} - ${errorText}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Dashboard_Export_${new Date().toISOString().split('T')[0]}.docx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('exportWordModal')).hide();
        showSuccess('Word document exported successfully!');
    } catch (error) {
        console.error('Error exporting to Word:', error);
        showError('Failed to export Word document');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

function showError(message) {
    showToast(message, 'error');
}

function showSuccess(message) {
    showToast(message, 'success');
}

function showToast(message, type) {
    const bgClass = type === 'success' ? 'bg-success' : type === 'info' ? 'bg-info' : 'bg-danger';
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${bgClass} border-0 position-fixed top-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    setTimeout(() => toast.remove(), 5000);
}

// Initialize count when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize export modal functionality
    const modal = document.getElementById('exportWordModal');
    if (modal) {
        // Update count initially
        updateExportSelectedCount();
        
        // Add change listeners to all checkboxes
        document.querySelectorAll('.export-chart-checkbox').forEach(cb => {
            cb.addEventListener('change', updateExportSelectedCount);
        });
        
        // Update count when modal is shown (in case DOM wasn't ready earlier)
        modal.addEventListener('shown.bs.modal', function() {
            updateExportSelectedCount();
            // Reattach listeners if needed
            document.querySelectorAll('.export-chart-checkbox').forEach(cb => {
                cb.removeEventListener('change', updateExportSelectedCount);
                cb.addEventListener('change', updateExportSelectedCount);
            });
        });
    }
});

// Expose functions to global scope for inline onclick handlers
window.selectAllExportCharts = selectAllExportCharts;
window.deselectAllExportCharts = deselectAllExportCharts;
window.exportSelectedChartsToWord = exportSelectedChartsToWord;
window.updateExportSelectedCount = updateExportSelectedCount;

</script>
{% endblock %}
