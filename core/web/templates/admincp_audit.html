<!--
================================================================================
Calaveras UniteUs ETL - Admin Control Panel Audit Log
================================================================================
Developed by Waqqas Hanafi
Calaveras County Health and Human Services Agency

Description:
    Admin control panel page for viewing and managing audit logs, including
    authentication events, system changes, and user activity tracking.
================================================================================
-->
{% extends "admincp_base.html" %}

{% set active_page = 'audit' %}
{% set page_title = 'Audit Log' %}
{% set page_icon = 'history' %}
{% set page_description = 'View system activity and user actions' %}

{% block admin_content %}
<div class="container-fluid px-4 py-3">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-list text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1" style="font-size: 12px;">Total Events</h6>
                            <h4 class="mb-0" id="auditTotalEvents">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-check-circle text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1" style="font-size: 12px;">Successful</h6>
                            <h4 class="mb-0" id="auditSuccessEvents">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-times-circle text-danger"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1" style="font-size: 12px;">Failed</h6>
                            <h4 class="mb-0" id="auditFailureEvents">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-users text-info"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1" style="font-size: 12px;">Unique Users</h6>
                            <h4 class="mb-0" id="auditUniqueUsers">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearAuditFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="applyAuditFilters()">
                        <i class="fas fa-search me-1"></i>Apply
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Category</label>
                    <select class="form-select form-select-sm" id="auditFilterCategory">
                        <option value="">All Categories</option>
                        <option value="authentication">Authentication</option>
                        <option value="user_management">User Management</option>
                        <option value="etl">ETL</option>
                        <option value="data_access">Data Access</option>
                        <option value="data_export">Data Export</option>
                        <option value="data_import">Data Import</option>
                        <option value="system">System</option>
                        <option value="security">Security</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Status</label>
                    <select class="form-select form-select-sm" id="auditFilterSuccess">
                        <option value="">All Status</option>
                        <option value="true">Success</option>
                        <option value="false">Failed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Username</label>
                    <input type="text" class="form-control form-control-sm" id="auditFilterUsername" placeholder="Filter by username">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Search</label>
                    <input type="text" class="form-control form-control-sm" id="auditFilterSearch" placeholder="Search in details, resource, error">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Start Date</label>
                    <input type="date" class="form-control form-control-sm" id="auditFilterStartDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">End Date</label>
                    <input type="date" class="form-control form-control-sm" id="auditFilterEndDate">
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Audit Log Entries</h5>
                <div>
                    <span class="text-muted small me-3">Showing <span id="auditResultsInfo">0</span> results</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportAuditToCSV()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" style="font-size: 13px;">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Category</th>
                            <th>Action</th>
                            <th>Resource/Details</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading audit logs...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white border-top">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="auditPrevBtn" onclick="previousAuditPage()" disabled>
                        <i class="fas fa-chevron-left me-1"></i>Previous
                    </button>
                    <span class="mx-3 small text-muted">Page <span id="auditCurrentPage">1</span></span>
                    <button class="btn btn-sm btn-outline-secondary" id="auditNextBtn" onclick="nextAuditPage()" disabled>
                        Next<i class="fas fa-chevron-right ms-1"></i>
                    </button>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadAuditLog()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Audit Log State
let auditCurrentPage = 1;
const auditPageSize = 50;
let auditCurrentFilters = {};
let allAuditLogs = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAuditLog();
    loadAuditStatistics();
    
    // Allow Enter key to apply filters
    ['auditFilterCategory', 'auditFilterSuccess', 'auditFilterUsername', 'auditFilterSearch', 'auditFilterStartDate', 'auditFilterEndDate'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyAuditFilters();
            }
        });
    });
});

async function loadAuditLog() {
    try {
        const params = new URLSearchParams({
            limit: auditPageSize,
            offset: (auditCurrentPage - 1) * auditPageSize,
            ...auditCurrentFilters
        });

        const response = await fetch(`/api/admin/audit-log?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        allAuditLogs = data.logs || [];
        
        renderAuditLogs(allAuditLogs);
        updateAuditPagination(allAuditLogs.length);
        
        // Update results info
        const start = (auditCurrentPage - 1) * auditPageSize + 1;
        const end = start + allAuditLogs.length - 1;
        document.getElementById('auditResultsInfo').textContent = 
            allAuditLogs.length > 0 ? `${start}-${end}` : '0';
        
    } catch (error) {
        console.error('Error loading audit log:', error);
        document.getElementById('auditTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5 text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Failed to load audit logs: ${error.message}
                </td>
            </tr>
        `;
    }
}

async function loadAuditStatistics() {
    try {
        const response = await fetchWithRoleCheck('/api/admin/audit-statistics');
        if (!response.ok) return;

        const data = await response.json();
        const stats = data.statistics;

        document.getElementById('auditTotalEvents').textContent = 
            stats.total_events?.toLocaleString() || '0';
        document.getElementById('auditSuccessEvents').textContent = 
            (stats.success_failure?.success || 0).toLocaleString();
        document.getElementById('auditFailureEvents').textContent = 
            (stats.success_failure?.failure || 0).toLocaleString();
        document.getElementById('auditUniqueUsers').textContent = 
            Object.keys(stats.by_user || {}).length;
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

function renderAuditLogs(logs) {
    const tbody = document.getElementById('auditTableBody');
    tbody.innerHTML = '';

    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5" style="color: #718096;">
                    <i class="fas fa-inbox me-2"></i>No audit logs found
                </td>
            </tr>
        `;
        return;
    }

    logs.forEach((log, index) => {
        const tr = createAuditRow(log, index);
        tbody.appendChild(tr);
    });
}

function createAuditRow(log, index) {
    const tr = document.createElement('tr');
    tr.style.cssText = 'border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background-color 0.15s;';
    tr.id = `audit-row-${index}`;
    tr.onmouseenter = () => tr.style.backgroundColor = '#f7fafc';
    tr.onmouseleave = () => tr.style.backgroundColor = tr.classList.contains('expanded') ? '#f7fafc' : '';
    tr.onclick = () => toggleAuditDetails(index);

    // Expand icon
    const iconTd = document.createElement('td');
    iconTd.style.cssText = 'padding: 10px; text-align: center;';
    iconTd.innerHTML = `<i class="fas fa-chevron-right" id="audit-icon-${index}" style="color: #a0aec0; font-size: 12px;"></i>`;
    tr.appendChild(iconTd);

    // Timestamp
    const timestamp = new Date(log.timestamp).toLocaleString();
    tr.appendChild(createCell(timestamp, {fontSize: '13px', color: '#4a5568', padding: '10px'}));

    // Username
    tr.appendChild(createCell(log.username || 'System', {fontSize: '13px', fontWeight: '500', padding: '10px'}));

    // Category badge
    const categoryBadge = document.createElement('span');
    categoryBadge.style.cssText = `font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: 600; text-transform: uppercase; color: white; background: ${getAuditCategoryColor(log.category)}`;
    categoryBadge.textContent = log.category || 'unknown';
    tr.appendChild(createCell(categoryBadge, {padding: '10px'}));

    // Action
    tr.appendChild(createCell((log.action || '').replace(/_/g, ' '), {fontSize: '13px', padding: '10px'}));

    // Resource/Details
    const resourceText = log.target_resource || log.details || '-';
    tr.appendChild(createCell(resourceText, {fontSize: '13px', maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', padding: '10px'}));

    // Status badge
    const statusBadge = document.createElement('span');
    statusBadge.style.cssText = `font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: 600; color: white; background: ${log.success ? '#48bb78' : '#f56565'}`;
    statusBadge.textContent = log.success ? 'SUCCESS' : 'FAILED';
    tr.appendChild(createCell(statusBadge, {padding: '10px'}));

    // Details row (hidden by default)
    const detailsTr = createAuditDetailsRow(log, index);
    tr.after(detailsTr);

    return tr;
}

function createAuditDetailsRow(log, index) {
    const tr = document.createElement('tr');
    tr.id = `audit-details-${index}`;
    tr.style.display = 'none';

    const td = document.createElement('td');
    td.colSpan = 7;
    td.style.cssText = 'background: #f7fafc; padding: 15px; border-top: 1px solid #e2e8f0;';
    
    let html = '<div class="row">';
    
    // Left column
    html += '<div class="col-md-6">';
    html += `<p class="mb-2"><strong>Timestamp:</strong> ${new Date(log.timestamp).toLocaleString()}</p>`;
    html += `<p class="mb-2"><strong>User:</strong> ${log.username || 'System'}</p>`;
    html += `<p class="mb-2"><strong>Category:</strong> ${log.category || 'N/A'}</p>`;
    html += `<p class="mb-2"><strong>Action:</strong> ${(log.action || '').replace(/_/g, ' ')}</p>`;
    if (log.ip_address) html += `<p class="mb-2"><strong>IP Address:</strong> <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px;">${log.ip_address}</code></p>`;
    if (log.session_id) html += `<p class="mb-2"><strong>Session ID:</strong> <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 3px;">${log.session_id.substring(0, 16)}...</code></p>`;
    html += '</div>';
    
    // Right column
    html += '<div class="col-md-6">';
    if (log.target_resource) html += `<p class="mb-2"><strong>Resource:</strong> ${log.target_resource}</p>`;
    if (log.target_user) html += `<p class="mb-2"><strong>Target User:</strong> ${log.target_user}</p>`;
    if (log.duration_ms) html += `<p class="mb-2"><strong>Duration:</strong> ${log.duration_ms}ms</p>`;
    if (log.record_count) html += `<p class="mb-2"><strong>Records:</strong> ${log.record_count.toLocaleString()}</p>`;
    if (log.file_size) html += `<p class="mb-2"><strong>File Size:</strong> ${formatBytes(log.file_size)}</p>`;
    if (log.details) html += `<p class="mb-2"><strong>Details:</strong> ${log.details}</p>`;
    if (log.error_message) html += `<p class="mb-2 text-danger"><strong>Error:</strong> ${log.error_message}</p>`;
    if (log.user_agent) html += `<p class="mb-2"><strong>User Agent:</strong> <small>${log.user_agent}</small></p>`;
    html += '</div>';
    
    html += '</div>';
    
    td.innerHTML = html;
    tr.appendChild(td);
    
    return tr;
}

function toggleAuditDetails(index) {
    const detailsRow = document.getElementById(`audit-details-${index}`);
    const icon = document.getElementById(`audit-icon-${index}`);
    const row = document.getElementById(`audit-row-${index}`);
    
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.className = 'fas fa-chevron-down';
        row.classList.add('expanded');
    } else {
        detailsRow.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
        row.classList.remove('expanded');
    }
}

function getAuditCategoryColor(category) {
    const colors = {
        'authentication': '#4299e1',
        'user_management': '#9f7aea',
        'etl': '#48bb78',
        'data_access': '#ed8936',
        'data_export': '#38b2ac',
        'data_import': '#667eea',
        'system': '#718096',
        'security': '#f56565'
    };
    return colors[category] || '#a0aec0';
}

function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function createCell(content, styles = {}) {
    const td = document.createElement('td');
    Object.assign(td.style, styles);
    if (typeof content === 'string') {
        td.textContent = content;
    } else {
        td.appendChild(content);
    }
    return td;
}

function applyAuditFilters() {
    auditCurrentFilters = {};
    
    const category = document.getElementById('auditFilterCategory').value;
    if (category) auditCurrentFilters.category = category;
    
    const success = document.getElementById('auditFilterSuccess').value;
    if (success) auditCurrentFilters.success = success === 'true';
    
    const username = document.getElementById('auditFilterUsername').value.trim();
    if (username) auditCurrentFilters.username = username;
    
    const startDate = document.getElementById('auditFilterStartDate').value;
    if (startDate) auditCurrentFilters.start_date = startDate;
    
    const endDate = document.getElementById('auditFilterEndDate').value;
    if (endDate) auditCurrentFilters.end_date = endDate;
    
    const search = document.getElementById('auditFilterSearch').value.trim();
    if (search) auditCurrentFilters.search = search;
    
    auditCurrentPage = 1;
    loadAuditLog();
}

function clearAuditFilters() {
    document.getElementById('auditFilterCategory').value = '';
    document.getElementById('auditFilterSuccess').value = '';
    document.getElementById('auditFilterUsername').value = '';
    document.getElementById('auditFilterStartDate').value = '';
    document.getElementById('auditFilterEndDate').value = '';
    document.getElementById('auditFilterSearch').value = '';
    
    auditCurrentFilters = {};
    auditCurrentPage = 1;
    loadAuditLog();
}

function updateAuditPagination(logsCount) {
    const prevBtn = document.getElementById('auditPrevBtn');
    const nextBtn = document.getElementById('auditNextBtn');
    
    prevBtn.disabled = auditCurrentPage === 1;
    nextBtn.disabled = logsCount < auditPageSize;
    
    document.getElementById('auditCurrentPage').textContent = auditCurrentPage;
}

function previousAuditPage() {
    if (auditCurrentPage > 1) {
        auditCurrentPage--;
        loadAuditLog();
    }
}

function nextAuditPage() {
    auditCurrentPage++;
    loadAuditLog();
}

async function exportAuditToCSV() {
    try {
        // Get all logs with current filters (no limit for export)
        const params = new URLSearchParams({
            limit: 10000,  // Large limit for export
            offset: 0,
            ...auditCurrentFilters
        });
        
        const response = await fetch(`/api/admin/audit-log?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const logs = data.logs || [];

        if (logs.length === 0) {
            alert('No data to export');
            return;
        }

        const csv = [
            ['Timestamp', 'Username', 'Category', 'Action', 'Resource', 'Status', 'IP Address', 'Details', 'Error'].join(','),
            ...logs.map(log => [
                new Date(log.timestamp).toISOString(),
                log.username || 'System',
                log.category || '',
                log.action || '',
                (log.target_resource || '').replace(/"/g, '""'),
                log.success ? 'Success' : 'Failed',
                log.ip_address || '',
                (log.details || '').replace(/"/g, '""').replace(/,/g, ';'),
                (log.error_message || '').replace(/"/g, '""').replace(/,/g, ';')
            ].map(field => `"${field}"`).join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Failed to export audit log: ' + error.message);
    }
}
</script>
{% endblock %}
